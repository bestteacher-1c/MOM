
#Область ПрограммныйИнтерфейс

// Метод для вызова из регламентного задания отражения в регл. учете
Процедура ОтразитьВсеРегламент() Экспорт
	
	ОбщегоНазначения.ПриНачалеВыполненияРегламентногоЗадания(Метаданные.РегламентныеЗадания.ОтражениеДокументовВРеглУчете);
	
	ТекущаяДата = ТекущаяДатаСеанса();
	УчетНДСУП.ВыполнитьФормированиеДвиженийПоНДС(КонецМесяца(ТекущаяДата));
	
	ОбновитьДанныеЗависимыхРегистров();
	
	ОтразитьВсе(КонецДня(ТекущаяДата));
	
КонецПроцедуры

// Метод для вызова в фоне отражения в регл. учете
Процедура ОтразитьВсеВФоне(Параметры, АдресХранилища) Экспорт
	
	ДанныеПоОтражениюВУчете = ИнициализироватьДанныеПоОтражениюВУчете();
	
	УчетНДСУП.ВыполнитьФормированиеДвиженийПоНДС(КонецМесяца(Параметры.ПериодРасчета), Параметры.Организация);
	ОтразитьВсе(
		КонецДня(Параметры.ПериодРасчета), 
		Параметры.Организация, 
		ДанныеПоОтражениюВУчете);
		
	ПоместитьВоВременноеХранилище(ДанныеПоОтражениюВУчете, АдресХранилища);
	
КонецПроцедуры

// Метод инициализирует дополнительную информацию по отражению документов в регл. учете (сколько отражено, количество ошибок).
//
//	Возвращаемое значение:
//		Структура - содержит результирующие данные по количеству отраженных документов в регламентированном учете:
//			* Отражено - Число - количество отраженных в учете документов.
//			* НеУказаныСчетаУчета - Число - количество документов, которые не были отражены в результате ненастроенных счетов учета.
//			* ОшибкиПриОтражении - Число - количество документов, которые не были отражены в результате прочих ошибок при отражении.
//
Функция ИнициализироватьДанныеПоОтражениюВУчете() Экспорт
	
	СтруктураРезультата = Новый Структура;
	СтруктураРезультата.Вставить("Отражено", 0);
	СтруктураРезультата.Вставить("НеУказаныСчетаУчета", 0);
	СтруктураРезультата.Вставить("ОшибкиПриОтражении", 0);
	
	Возврат СтруктураРезультата;
	
КонецФункции

// Формирует движения по регистру Хозрасчетный для всех документов, помеченных к отражению в регламентированном учете.
//
// Параметры:
// 	ПериодРасчета - Дата - Дата, по которую документы необходимо отразить в учете
// 	Организация - СправочникСсылка.Организации, Неопределено - Организация, по которой необходимо отразить документы в учете.
// 																Если Неопределено, то по всем организациям.
//	ДанныеПоОтражениюВУчете - Структура - (см. функцию "ИнициализироватьДанныеПоОтражениюВУчете")
//		содержит результирующие данные по количеству отраженных документов в регламентированном учете:
// 		* Отражено - Число - в значение параметра устанавливается количество отраженных в учете документов
// 		* НеУказаныСчетаУчета - Число - в значение параметра устанавливается количество документов, 
// 											которые не удалось отразить в учете из-за ненастроенных счетов учета. 
// 		*ОшибкиПриОтражении - Число - в значение параметра устанавливается количество документов при отражении которых возникли ошибки.
//
Процедура ОтразитьВсе(ПериодРасчета, Организация = Неопределено, ДанныеПоОтражениюВУчете = Неопределено) Экспорт
	
	Если Не ПолучитьФункциональнуюОпцию("ИспользоватьРеглУчет") Тогда
		Возврат;
	КонецЕсли;
	
	Если ДанныеПоОтражениюВУчете = Неопределено Тогда
		ДанныеПоОтражениюВУчете = ИнициализироватьДанныеПоОтражениюВУчете();
	КонецЕсли;
	
	ВременныеТаблицы = ВременныеТаблицы();
	
	// Отразим документы пакетно
	ТипыДокументов = ТипыДокументовКПакетномуОтражению(ПериодРасчета, Организация);
	Для каждого ТипДокумента Из ТипыДокументов Цикл
		Результат = ОтразитьДокументыПакетноСЗамеромВремени(ТипДокумента, ВременныеТаблицы, Организация, ПериодРасчета);
		ДанныеПоОтражениюВУчете.Отражено = ДанныеПоОтражениюВУчете.Отражено + Результат.КоличествоОтраженоВУчете;
		ДанныеПоОтражениюВУчете.НеУказаныСчетаУчета = ДанныеПоОтражениюВУчете.НеУказаныСчетаУчета + Результат.КоличествоНеУказаныСчетаУчета;
		ДанныеПоОтражениюВУчете.ОшибкиПриОтражении = ДанныеПоОтражениюВУчете.ОшибкиПриОтражении + Результат.КоличествоОшибкиПриОтражении;
	КонецЦикла;
	
	// Отразим документы последовательно
	Результат = ОтразитьДокументыПоследовательноСЗамеромВремени(ВременныеТаблицы, Организация, ПериодРасчета);
	ДанныеПоОтражениюВУчете.Отражено = ДанныеПоОтражениюВУчете.Отражено + Результат.КоличествоОтраженоВУчете;
	ДанныеПоОтражениюВУчете.НеУказаныСчетаУчета = ДанныеПоОтражениюВУчете.НеУказаныСчетаУчета + Результат.КоличествоНеУказаныСчетаУчета;
	ДанныеПоОтражениюВУчете.ОшибкиПриОтражении = ДанныеПоОтражениюВУчете.ОшибкиПриОтражении + Результат.КоличествоОшибкиПриОтражении;
	
	ВременныеТаблицы.Закрыть();
	
	Если ДанныеПоОтражениюВУчете.ОшибкиПриОтражении > 0 Тогда
		ВызватьИсключение НСтр("ru = 'При отражении документов в регл. учете возникли ошибки. Подробнее см. в журнале регистрации.'");
	КонецЕсли;
	
КонецПроцедуры

// Формирует движения по регистру Хозрасчетный для указанных документов
//
// Параметры:
//    МассивДокументов - Массив - Документы
//    ВыполнитьПересчеты - Булево - Признак, что перед отражением документа необходимо выполнить отражение в учете НДС и
//                                  распределение взаиморасчетов.
//
// Возвращаемое значение:
//    Массив - Документы, которые не удалось отразить в регл. учете.
//
Функция ОтразитьДокументыВРеглУчете(МассивДокументов, ВыполнитьПересчеты = Ложь) Экспорт
	
	Если Не ПолучитьФункциональнуюОпцию("ИспользоватьРеглУчет") Тогда
		Возврат МассивДокументов;
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Истина);
	
	НеотраженныеДокументы = Новый Массив;
	
	Если ВыполнитьПересчеты Тогда
		ВыполнитьОффлайновыеРасчеты(МассивДокументов);
	КонецЕсли;
	
	ВременныеТаблицы = ВременныеТаблицы();
	
	// Отразим документы пакетно
	ТипыДокументов = ТипыДокументовКПакетномуОтражению(, , МассивДокументов);
	Для каждого ТипДокумента Из ТипыДокументов Цикл
		Пока СформироватьТаблицыОтбораДанных(ТипДокумента, ВременныеТаблицы, , , МассивДокументов, НеотраженныеДокументы) Цикл
			Результат = ВыполнитьОтражение(ТипДокумента, ВременныеТаблицы);
			ОбщегоНазначенияКлиентСервер.ДополнитьМассив(НеотраженныеДокументы, Результат.НеУказаныСчетаУчета);
			ОбщегоНазначенияКлиентСервер.ДополнитьМассив(НеотраженныеДокументы, Результат.ОшибкиПриОтражении);
		КонецЦикла;
	КонецЦикла;
	
	// Отразим документы последовательно
	Выборка = ДокументыКПоследовательномуОтражению(, , МассивДокументов);
	Если Не Выборка = Неопределено Тогда
		Пока Выборка.Следующий() Цикл
			ТипДокумента = ТипЗнч(Выборка.Ссылка);
			Если СформироватьТаблицыОтбораДанных(ТипДокумента, ВременныеТаблицы, , , Выборка.Ссылка) Тогда
				Результат = ВыполнитьОтражение(ТипДокумента, ВременныеТаблицы);
				ОбщегоНазначенияКлиентСервер.ДополнитьМассив(НеотраженныеДокументы, Результат.НеУказаныСчетаУчета);
				ОбщегоНазначенияКлиентСервер.ДополнитьМассив(НеотраженныеДокументы, Результат.ОшибкиПриОтражении);
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	ВременныеТаблицы.Закрыть();
	
	Возврат НеотраженныеДокументы;
	
КонецФункции

// Формирует движения по регистру Хозрасчетный для указанных документов
//
// Параметры:
//    МассивДокументов - Массив - Документы.
//
// Возвращаемое значение:
//    Массив - Документы, которые не удалось отразить в регл. учете.
//
Функция ОтразитьДокументыВРеглУчетеПриПечати(МассивДокументов) Экспорт
	
	Возврат ОтразитьДокументыВРеглУчете(МассивДокументов, Истина);
	
КонецФункции

// Формирует движения по регистру Хозрасчетный для указанного документа. Аналог "ОтразитьДокумент", вызываемый для
// фоновых операций.
//
// Параметры:
// 	ПараметрыОтражения - Структура - Параметры отражения:
// 		*РеквизитыДокумента - Структура - реквизиты документа:
// 			** Ссылка - ДокументСсылка - ссылка на документ
// 			** Дата - Дата - Дата документа
// 			** Организация - СправочникСсылка.Организации - Организация документа
//		* ВыполнитьПересчеты - Булево - Если истина, запускает актуализацию взаиморасчетов с партнерами
//		* ОтборПоОрганизациям - СправочникСсылка.Организации, Массив Из СправочникСсылка.Организации, Неопределено -
// 	АдресРезультата - Строка - Адрес временного хранилища для помещения результата.
//
Процедура ОтразитьДокументВФоне(ПараметрыОтражения, АдресРезультата) Экспорт
	
	Статус = ОтразитьДокумент(ПараметрыОтражения.РеквизитыДокумента, ПараметрыОтражения.ВыполнитьПересчеты,,
		ОбщегоНазначенияКлиентСервер.СвойствоСтруктуры(ПараметрыОтражения, "ОтборПоОрганизациям"));
	
	ПоместитьВоВременноеХранилище(Статус, АдресРезультата);
	
КонецПроцедуры

// Формирует движения по регистру Хозрасчетный для указанного документа.
//
// Параметры:
// 	РеквизитыДокумента - Структура - реквизиты документа:
// 		* Ссылка - ДокументСсылка - ссылка на документ
// 		* Дата - Дата - Дата документа
// 		* Организация - СправочникСсылка.Организации - Организация документа
// 	ВыполнитьПересчеты - Булево - Признак необходимости выполнить пересчеты
// 	МенеджерВременныхТаблиц - МенеджерВременныхТаблиц - Поставляемый внешний менеджер временных таблиц.
// 	ОтборПоОрганизациям - СправочникСсылка.Организации, Массив Из СправочникСсылка.Организации -
//
// Возвращаемое значение:
//    ПеречислениеСсылка.СтатусыОтраженияДокументовВРеглУчете - Статус отражения документа в учете.
//
Функция ОтразитьДокумент(РеквизитыДокумента, ВыполнитьПересчеты = Ложь, МенеджерВременныхТаблиц = Неопределено, ОтборПоОрганизациям = Неопределено) Экспорт
	
	ТипДокумента = ТипЗнч(РеквизитыДокумента.Ссылка);
	Статусы = Перечисления.СтатусыОтраженияДокументовВРеглУчете;
	
	УстановитьПривилегированныйРежим(Истина);
	
	Если РеквизитыДокумента.Организация = Справочники.Организации.УправленческаяОрганизация Тогда
		Возврат Статусы.ОтраженоВРеглУчете;
	КонецЕсли;
	
	Если ВыполнитьПересчеты Тогда
		ВыполнитьОффлайновыеРасчеты(РеквизитыДокумента.Ссылка);
	КонецЕсли;
	
	ВременныеТаблицы = ВременныеТаблицы(МенеджерВременныхТаблиц); 
	
	Если НЕ СформироватьТаблицыОтбораДанных(ТипДокумента, ВременныеТаблицы, ОтборПоОрганизациям, , РеквизитыДокумента.Ссылка) Тогда
		Возврат Статусы.ОтраженоВРеглУчете;
	КонецЕсли;
	
	РезультатОтражения = ВыполнитьОтражение(ТипДокумента, ВременныеТаблицы);
	ВременныеТаблицы.Закрыть();
	
	Если РезультатОтражения.ОтраженоВУчете.Количество() = 1 Тогда
		Статус = Статусы.ОтраженоВРеглУчете;
	Иначе
		Статус = Статусы.НеУказаныСчетаУчета;
	КонецЕсли;
	
	Возврат Статус;
	
КонецФункции

// Записывает движения по регистру ОтражениеДокументаВРеглУчете, выполняет очистку неактуальных записей в Хозрасчетный.
// Вызывается из обработки проведения документов.
//
// Параметры:
// 	Объект - ДокументОбъект - документ, который необходимо зарегистрировать к отражению
// 	ДополнительныеСвойства - Структура - содержит доп. параметры регистрации:
// 								* НеРегистрироватьКОтражениюВРеглУчете - Булево - Признак того, что документ не надо регистрировать к отражению.
// 								* ТаблицаОтражениеДокументовВРеглУчете - ТаблицаЗначений - Готовая таблица регистрации.
// 								* ВыборочнаяРегистрацияКОтражениюВРеглУчете - Булево - Признак того, то регистрацию к отражению необходимо выполнить только в выбранных периодах/организациях.
// 								* ТаблицаВыборочнойРегистрации - ТаблицаЗначений - Таблица с разрезами выборочной регистрации.
//
Процедура ЗарегистрироватьКОтражению(Объект, ДополнительныеСвойства, Движения, Отказ) Экспорт
	
	Если Отказ ИЛИ Не ПолучитьФункциональнуюОпцию("ИспользоватьРеглУчет") Тогда
	 	Возврат;
	КонецЕсли;
	
	Если ДополнительныеСвойства.Свойство("НеРегистрироватьКОтражениюВРеглУчете") 
		 И ДополнительныеСвойства.НеРегистрироватьКОтражениюВРеглУчете Тогда
		Возврат;
	КонецЕсли;
	
	Если ТипЗнч(Движения) = Тип("Структура") Тогда
		
		Если НЕ Объект.Свойство("Дата") Тогда
			ДатаДокумента = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Объект.Ссылка, "Дата");
			Объект.Вставить("Дата", ДатаДокумента);
		КонецЕсли;
		
		Если НЕ Движения.Свойство("Хозрасчетный") Тогда
			Хозрасчетный = РегистрыБухгалтерии.Хозрасчетный.СоздатьНаборЗаписей();
			Хозрасчетный.Отбор.Регистратор.Установить(Объект.Ссылка);
			Движения.Вставить("Хозрасчетный", Хозрасчетный);
		КонецЕсли;
		
		Если НЕ Движения.Свойство("ОтражениеДокументовВРеглУчете") Тогда
			ОтражениеДокументовВРеглУчете = РегистрыСведений.ОтражениеДокументовВРеглУчете.СоздатьНаборЗаписей();
			ОтражениеДокументовВРеглУчете.Отбор.Регистратор.Установить(Объект.Ссылка);
			Движения.Вставить("ОтражениеДокументовВРеглУчете", ОтражениеДокументовВРеглУчете);
		КонецЕсли;
		
	КонецЕсли;
	
	ДвиженияХозрасчетный = Движения.Хозрасчетный;
	УстановитьДопСвойстваНабораЗаписейХозрасчетный(ДвиженияХозрасчетный, Объект.Ссылка);
	ДвиженияХозрасчетный.Записывать = Истина;
	
	ДвиженияОтражениеДокументовВРеглУчете = Движения.ОтражениеДокументовВРеглУчете;
	ДвиженияОтражениеДокументовВРеглУчете.Записывать = Истина;
	
	ТаблицаДанные = Новый ТаблицаЗначений;
	ТаблицаДанные.Колонки.Добавить("Период",         Новый ОписаниеТипов("Дата"));
	ТаблицаДанные.Колонки.Добавить("Организация",    Новый ОписаниеТипов("СправочникСсылка.Организации"));
	ТаблицаДанные.Колонки.Добавить("ДатаОтражения",  Новый ОписаниеТипов("Дата"));
	ТаблицаДанные.Колонки.Добавить("Статус",         Новый ОписаниеТипов("ПеречислениеСсылка.СтатусыОтраженияДокументовВРеглУчете"));
	
	ТаблицаОтражениеДокументовВРеглУчете = Неопределено;
	ПереданаТаблицаОтражениеДокументовВРеглУчете = 
			ДополнительныеСвойства.ТаблицыДляДвижений.Свойство("ТаблицаОтражениеДокументовВРеглУчете", ТаблицаОтражениеДокументовВРеглУчете)
			ИЛИ ДополнительныеСвойства.ТаблицыДляДвижений.Свойство("ОтражениеДокументовВРеглУчете", ТаблицаОтражениеДокументовВРеглУчете);
	
	Если ПереданаТаблицаОтражениеДокументовВРеглУчете  Тогда 
		// В модуле менеджера была подготовлена таблица данных для регистрации.
		ОбщегоНазначенияКлиентСервер.ДополнитьТаблицу(
			ТаблицаОтражениеДокументовВРеглУчете, 
			ТаблицаДанные);
	Иначе
		// Документ регистрируется общим порядком:
		// - датой документа
		// - по организации документа.
		НоваяСтрока = ТаблицаДанные.Добавить();
		НоваяСтрока.Период         = Объект.Дата;
		НоваяСтрока.Организация    = Объект.Организация;
		НоваяСтрока.ДатаОтражения  = НачалоДня(Объект.Дата);
	КонецЕсли;
	
	СтрокиКУдалению = Новый Массив;
	НачалоОтраженияВРеглУчете = Константы.ДатаНачалаВеденияРеглУчета.Получить();
	ТаблицаДанные.Свернуть("Период, Организация, ДатаОтражения", "Статус");
	Для каждого Строка Из ТаблицаДанные Цикл
		Если Не ЗначениеЗаполнено(Строка.ДатаОтражения) Тогда
			Строка.ДатаОтражения = НачалоДня(Строка.Период);
		КонецЕсли;
		Если Не ЗначениеЗаполнено(Строка.Статус) Тогда
			Строка.Статус = Перечисления.СтатусыОтраженияДокументовВРеглУчете.КОтражениюВРеглУчете;
		КонецЕсли;
		Если Строка.Организация = Справочники.Организации.УправленческаяОрганизация
			ИЛИ Не ДокументОтражаетсяВРеглУчете(Объект.Ссылка, Строка.ДатаОтражения) Тогда
			СтрокиКУдалению.Добавить(Строка);
		КонецЕсли;
	КонецЦикла;
	
	Для каждого Строка Из СтрокиКУдалению Цикл
		ТаблицаДанные.Удалить(Строка);
	КонецЦикла;
	
	ВыборочнаяРегистрацияКОтражениюВРеглУчете = 
		ДополнительныеСвойства.Свойство("ВыборочнаяРегистрацияКОтражениюВРеглУчете")
		И ДополнительныеСвойства.ВыборочнаяРегистрацияКОтражениюВРеглУчете;
	ИспользуетсяРучнаяКорректировкаПроводок = ПолучитьФункциональнуюОпцию("ИспользоватьРучнуюКорректировкуПроводокПоРеглУчету");
	
	Если Не ИспользуетсяРучнаяКорректировкаПроводок И Не ВыборочнаяРегистрацияКОтражениюВРеглУчете Тогда
		ДвиженияОтражениеДокументовВРеглУчете.Загрузить(ТаблицаДанные);
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("Ссылка",                  Объект.Ссылка);
	Запрос.УстановитьПараметр("Период",                  Объект.Дата);
	Запрос.УстановитьПараметр("ТаблицаДанные",           ТаблицаДанные);
	Запрос.УстановитьПараметр("ОтраженоВРеглУчете",      Перечисления.СтатусыОтраженияДокументовВРеглУчете.ОтраженоВРеглУчете);
	Запрос.УстановитьПараметр("КОтражениюВРеглУчете",    Перечисления.СтатусыОтраженияДокументовВРеглУчете.КОтражениюВРеглУчете);
	Запрос.УстановитьПараметр("ОтраженоВУчетеВручную",   Перечисления.СтатусыОтраженияДокументовВРеглУчете.ОтраженоВУчетеВручную);
	Запрос.УстановитьПараметр("КОтражениюВУчетеВручную", Перечисления.СтатусыОтраженияДокументовВРеглУчете.КОтражениюВУчетеВручную);
	Запрос.УстановитьПараметр("ПустойВидСубконто",       ПланыВидовХарактеристик.ВидыСубконтоХозрасчетные.ПустаяСсылка());
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ОтражениеДокументов.Организация КАК Организация,
	|	ОтражениеДокументов.ДатаОтражения КАК ДатаОтражения,
	|	ОтражениеДокументов.Статус КАК Статус,
	|	ОтражениеДокументов.Комментарий КАК Комментарий
	|ПОМЕСТИТЬ ТекущиеСтатусы
	|ИЗ
	|	РегистрСведений.ОтражениеДокументовВРеглУчете КАК ОтражениеДокументов
	|ГДЕ
	|	ОтражениеДокументов.Регистратор = &Ссылка
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	ДатаОтражения
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	1 КАК Поле1
	|ИЗ
	|	ТекущиеСтатусы КАК ТекущиеСтатусы
	|ГДЕ
	|	ТекущиеСтатусы.Статус В (&ОтраженоВУчетеВручную, &КОтражениюВУчетеВручную)";
	
	Результат = Запрос.Выполнить();
	
	РучнаяКорректировкаПроводок = Не Результат.Пустой();
	
	Если Не РучнаяКорректировкаПроводок И Не ВыборочнаяРегистрацияКОтражениюВРеглУчете Тогда
		ДвиженияОтражениеДокументовВРеглУчете.Загрузить(ТаблицаДанные);
		Возврат;
	ИначеЕсли РучнаяКорректировкаПроводок Тогда
		
		#Область ТекстЗапросаРучнаяКорректировка
		Запрос.Текст =
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ТаблицаДанные.Организация    КАК Организация,
		|	ТаблицаДанные.ДатаОтражения КАК ДатаОтражения
		|ПОМЕСТИТЬ ДанныеКОтражению
		|ИЗ
		|	&ТаблицаДанные КАК ТаблицаДанные
		|ИНДЕКСИРОВАТЬ ПО
		|	Организация,
		|	ДатаОтражения
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	&Период КАК Период,
		|	ТекущиеСтатусы.Организация КАК Организация,
		|	ТекущиеСтатусы.ДатаОтражения КАК ДатаОтражения,
		|	&КОтражениюВУчетеВручную КАК Статус,
		|	ТекущиеСтатусы.Комментарий КАК Комментарий
		|ИЗ
		|	ТекущиеСтатусы КАК ТекущиеСтатусы
		|	
		|	ЛЕВОЕ СОЕДИНЕНИЕ 
		|		ДанныеКОтражению КАК ДанныеКОтражению
		|	ПО 
		|		ТекущиеСтатусы.Организация = ДанныеКОтражению.Организация
		|		И ТекущиеСтатусы.ДатаОтражения = ДанныеКОтражению.ДатаОтражения
		|	
		|ОБЪЕДИНИТЬ ВСЕ
		|	
		|ВЫБРАТЬ
		|	&Период КАК Период,
		|	ДанныеКОтражению.Организация КАК Организация,
		|	ДанныеКОтражению.ДатаОтражения КАК ДатаОтражения,
		|	&КОтражениюВУчетеВручную КАК Статус,
		|	"""" КАК Комментарий
		|ИЗ
		|	ДанныеКОтражению КАК ДанныеКОтражению
		|	
		|	ЛЕВОЕ СОЕДИНЕНИЕ 
		|		ТекущиеСтатусы КАК ТекущиеСтатусы
		|	ПО 
		|		ТекущиеСтатусы.Организация = ДанныеКОтражению.Организация
		|		И ТекущиеСтатусы.ДатаОтражения = ДанныеКОтражению.ДатаОтражения
		|ГДЕ
		|	ТекущиеСтатусы.Организация ЕСТЬ NULL
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Хозрасчетный.Период                                       КАК Период,
		|	Хозрасчетный.Организация                                  КАК Организация,
		|	
		|	Хозрасчетный.ПодразделениеДт                              КАК ПодразделениеДт,
		|	Хозрасчетный.НаправлениеДеятельностиДт                    КАК НаправлениеДеятельностиДт,
		|	Хозрасчетный.СчетДт                                       КАК СчетДт,
		|	ЕСТЬNULL(Хозрасчетный.ВидСубконтоДт1, &ПустойВидСубконто) КАК ВидСубконтоДт1,
		|	ЕСТЬNULL(Хозрасчетный.СубконтоДт1, НЕОПРЕДЕЛЕНО)          КАК СубконтоДт1,
		|	ЕСТЬNULL(Хозрасчетный.ВидСубконтоДт2, &ПустойВидСубконто) КАК ВидСубконтоДт2,
		|	ЕСТЬNULL(Хозрасчетный.СубконтоДт2, НЕОПРЕДЕЛЕНО)          КАК СубконтоДт2,
		|	ЕСТЬNULL(Хозрасчетный.ВидСубконтоДт3, &ПустойВидСубконто) КАК ВидСубконтоДт3,
		|	ЕСТЬNULL(Хозрасчетный.СубконтоДт3, НЕОПРЕДЕЛЕНО)          КАК СубконтоДт3,
		|	Хозрасчетный.ВалютаДт                                     КАК ВалютаДт,
		|	Хозрасчетный.ВалютнаяСуммаДт                              КАК ВалютнаяСуммаДт,
		|	Хозрасчетный.КоличествоДт                                 КАК КоличествоДт,
		|	
		|	Хозрасчетный.ПодразделениеКт                              КАК ПодразделениеКт,
		|	Хозрасчетный.НаправлениеДеятельностиКт                    КАК НаправлениеДеятельностиКт,
		|	Хозрасчетный.СчетКт                                       КАК СчетКт,
		|	ЕСТЬNULL(Хозрасчетный.ВидСубконтоКт1, &ПустойВидСубконто) КАК ВидСубконтоКт1,
		|	ЕСТЬNULL(Хозрасчетный.СубконтоКт1, НЕОПРЕДЕЛЕНО)          КАК СубконтоКт1,
		|	ЕСТЬNULL(Хозрасчетный.ВидСубконтоКт2, &ПустойВидСубконто) КАК ВидСубконтоКт2,
		|	ЕСТЬNULL(Хозрасчетный.СубконтоКт2, НЕОПРЕДЕЛЕНО)          КАК СубконтоКт2,
		|	ЕСТЬNULL(Хозрасчетный.ВидСубконтоКт3, &ПустойВидСубконто) КАК ВидСубконтоКт3,
		|	ЕСТЬNULL(Хозрасчетный.СубконтоКт3, НЕОПРЕДЕЛЕНО)          КАК СубконтоКт3,
		|	Хозрасчетный.ВалютаКт                                     КАК ВалютаКт,
		|	Хозрасчетный.ВалютнаяСуммаКт                              КАК ВалютнаяСуммаКт,
		|	Хозрасчетный.КоличествоКт                                 КАК КоличествоКт,
		|	
		|	Хозрасчетный.Сумма                                        КАК Сумма,
		|	Хозрасчетный.СуммаУУ                                      КАК СуммаУУ,
		|	Хозрасчетный.СуммаФО                                      КАК СуммаФО,
		|	Хозрасчетный.СуммаНУДт                                    КАК СуммаНУДт,
		|	Хозрасчетный.СуммаНУКт                                    КАК СуммаНУКт,
		|	Хозрасчетный.СуммаПРДт                                    КАК СуммаПРДт,
		|	Хозрасчетный.СуммаПРКт                                    КАК СуммаПРКт,
		|	Хозрасчетный.СуммаВРДт                                    КАК СуммаВРДт,
		|	Хозрасчетный.СуммаВРКт                                    КАК СуммаВРКт,
		|	
		|	Хозрасчетный.Содержание                                   КАК Содержание,
		|	Хозрасчетный.НеКорректироватьСтоимостьАвтоматически       КАК НеКорректироватьСтоимостьАвтоматически
		|ИЗ
		|	РегистрБухгалтерии.Хозрасчетный.ДвиженияССубконто(,,Регистратор = &Ссылка,,) КАК Хозрасчетный
		|";
		#КонецОбласти
	
		Запрос.УстановитьПараметр("ТаблицаДанные", ТаблицаДанные);
		Результат = Запрос.ВыполнитьПакет();
	
	Иначе //выборочная регистрация
		
		#Область ТекстЗапросаВыборочнаяРегистрация
		Запрос.Текст =
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ТаблицаДанных.Период         КАК Период,
		|	ТаблицаДанных.Организация    КАК Организация,
		|	ТаблицаДанных.ДатаОтражения  КАК ДатаОтражения
		|ПОМЕСТИТЬ НовыеДанные
		|ИЗ
		|	&ТаблицаДанные КАК ТаблицаДанных
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ТаблицаВыборочнойРегистрации.Организация    КАК Организация,
		|	ТаблицаВыборочнойРегистрации.ДатаОтражения КАК ДатаОтражения
		|ПОМЕСТИТЬ ДанныеКОтражению
		|ИЗ
		|	&ТаблицаВыборочнойРегистрации КАК ТаблицаВыборочнойРегистрации
		|ИНДЕКСИРОВАТЬ ПО
		|	Организация,
		|	ДатаОтражения
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	&Период КАК Период,
		|	НовыеДанные.Организация КАК Организация,
		|	НовыеДанные.ДатаОтражения КАК ДатаОтражения,
		|	ВЫБОР
		|		КОГДА ДанныеКОтражению.ДатаОтражения ЕСТЬ NULL И НЕ ТекущиеСтатусы.Статус ЕСТЬ NULL
		|			ТОГДА ТекущиеСтатусы.Статус
		|		ИНАЧЕ &КОтражениюВРеглУчете
		|	КОНЕЦ КАК Статус,
		|	ВЫБОР
		|		КОГДА ДанныеКОтражению.ДатаОтражения ЕСТЬ NULL
		|			ТОГДА ТекущиеСтатусы.Комментарий
		|		ИНАЧЕ """"
		|	КОНЕЦ КАК Комментарий
		|ПОМЕСТИТЬ НовыеСтатусы
		|ИЗ
		|	НовыеДанные КАК НовыеДанные
		|	ЛЕВОЕ СОЕДИНЕНИЕ 
		|		ТекущиеСтатусы КАК ТекущиеСтатусы
		|	ПО 
		|		НовыеДанные.Организация = ТекущиеСтатусы.Организация
		|		И НовыеДанные.ДатаОтражения = ТекущиеСтатусы.ДатаОтражения
		|	
		|	ЛЕВОЕ СОЕДИНЕНИЕ 
		|		ДанныеКОтражению КАК ДанныеКОтражению
		|	ПО 
		|		НовыеДанные.Организация = ДанныеКОтражению.Организация	
		|		И НовыеДанные.ДатаОтражения = ДанныеКОтражению.ДатаОтражения
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Таблица.Организация КАК Организация,
		|	Таблица.ДатаОтражения КАК ДатаОтражения
		|ПОМЕСТИТЬ ИзмененияСтатусов
		|ИЗ
		|	(ВЫБРАТЬ
		|		Таблица.ДатаОтражения КАК ДатаОтражения,
		|		Таблица.Организация КАК Организация,
		|		ВЫБОР
		|			КОГДА Таблица.Статус = &КОтражениюВРеглУчете
		|				ТОГДА 1
		|			КОГДА Таблица.Статус = &ОтраженоВРеглУчете
		|				ТОГДА 2
		|		КОНЕЦ КАК Статус
		|	ИЗ
		|		НовыеСтатусы КАК Таблица
		|	ГДЕ
		|		Таблица.Статус В (&КОтражениюВРеглУчете, &ОтраженоВРеглУчете)
		|		
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		Таблица.ДатаОтражения,
		|		Таблица.Организация,
		|		ВЫБОР
		|			КОГДА Таблица.Статус = &КОтражениюВРеглУчете
		|				ТОГДА -1
		|			КОГДА Таблица.Статус = &ОтраженоВРеглУчете
		|				ТОГДА -2
		|		КОНЕЦ
		|	ИЗ
		|		ТекущиеСтатусы КАК Таблица
		|	ГДЕ
		|		Таблица.Статус В (&КОтражениюВРеглУчете, &ОтраженоВРеглУчете)) КАК Таблица,
		|
		|	(ВЫБРАТЬ
		|		МИНИМУМ(ДанныеКОтражению.ДатаОтражения) КАК ДатаОтражения
		|	ИЗ
		|		ДанныеКОтражению КАК ДанныеКОтражению) КАК НачалоИзменений
		|ГДЕ
		|	Таблица.ДатаОтражения >= ЕСТЬNULL(НАЧАЛОПЕРИОДА(НачалоИзменений.ДатаОтражения, МЕСЯЦ), ДАТАВРЕМЯ(1,1,1))
		|
		|СГРУППИРОВАТЬ ПО
		|	Таблица.ДатаОтражения,
		|	Таблица.Организация
		|
		|ИМЕЮЩИЕ
		|	СУММА(Таблица.Статус) <> 0
		|;
		|
		|ВЫБРАТЬ
		|	НовыеСтатусы.Период          КАК Период,
		|	НовыеСтатусы.Организация     КАК Организация,
		|	НовыеСтатусы.ДатаОтражения  КАК ДатаОтражения,
		|	НовыеСтатусы.Статус          КАК Статус,
		|	НовыеСтатусы.Комментарий     КАК Комментарий
		|ИЗ
		|	НовыеСтатусы КАК НовыеСтатусы
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Хозрасчетный.Период                                       КАК Период,
		|	Хозрасчетный.Организация                                  КАК Организация,
		|	
		|	Хозрасчетный.ПодразделениеДт                              КАК ПодразделениеДт,
		|	Хозрасчетный.НаправлениеДеятельностиДт                    КАК НаправлениеДеятельностиДт,
		|	Хозрасчетный.СчетДт                                       КАК СчетДт,
		|	ЕСТЬNULL(Хозрасчетный.ВидСубконтоДт1, &ПустойВидСубконто) КАК ВидСубконтоДт1,
		|	ЕСТЬNULL(Хозрасчетный.СубконтоДт1, НЕОПРЕДЕЛЕНО)          КАК СубконтоДт1,
		|	ЕСТЬNULL(Хозрасчетный.ВидСубконтоДт2, &ПустойВидСубконто) КАК ВидСубконтоДт2,
		|	ЕСТЬNULL(Хозрасчетный.СубконтоДт2, НЕОПРЕДЕЛЕНО)          КАК СубконтоДт2,
		|	ЕСТЬNULL(Хозрасчетный.ВидСубконтоДт3, &ПустойВидСубконто) КАК ВидСубконтоДт3,
		|	ЕСТЬNULL(Хозрасчетный.СубконтоДт3, НЕОПРЕДЕЛЕНО)          КАК СубконтоДт3,
		|	Хозрасчетный.ВалютаДт                                     КАК ВалютаДт,
		|	Хозрасчетный.ВалютнаяСуммаДт                              КАК ВалютнаяСуммаДт,
		|	Хозрасчетный.КоличествоДт                                 КАК КоличествоДт,
		|	
		|	Хозрасчетный.ПодразделениеКт                              КАК ПодразделениеКт,
		|	Хозрасчетный.НаправлениеДеятельностиКт                    КАК НаправлениеДеятельностиКт,
		|	Хозрасчетный.СчетКт                                       КАК СчетКт,
		|	ЕСТЬNULL(Хозрасчетный.ВидСубконтоКт1, &ПустойВидСубконто) КАК ВидСубконтоКт1,
		|	ЕСТЬNULL(Хозрасчетный.СубконтоКт1, НЕОПРЕДЕЛЕНО)          КАК СубконтоКт1,
		|	ЕСТЬNULL(Хозрасчетный.ВидСубконтоКт2, &ПустойВидСубконто) КАК ВидСубконтоКт2,
		|	ЕСТЬNULL(Хозрасчетный.СубконтоКт2, НЕОПРЕДЕЛЕНО)          КАК СубконтоКт2,
		|	ЕСТЬNULL(Хозрасчетный.ВидСубконтоКт3, &ПустойВидСубконто) КАК ВидСубконтоКт3,
		|	ЕСТЬNULL(Хозрасчетный.СубконтоКт3, НЕОПРЕДЕЛЕНО)          КАК СубконтоКт3,
		|	Хозрасчетный.ВалютаКт                                     КАК ВалютаКт,
		|	Хозрасчетный.ВалютнаяСуммаКт                              КАК ВалютнаяСуммаКт,
		|	Хозрасчетный.КоличествоКт                                 КАК КоличествоКт,
		|	
		|	Хозрасчетный.Сумма                                        КАК Сумма,
		|	Хозрасчетный.СуммаУУ                                      КАК СуммаУУ,
		|	Хозрасчетный.СуммаФО                                      КАК СуммаФО,
		|	Хозрасчетный.СуммаНУДт                                    КАК СуммаНУДт,
		|	Хозрасчетный.СуммаНУКт                                    КАК СуммаНУКт,
		|	Хозрасчетный.СуммаПРДт                                    КАК СуммаПРДт,
		|	Хозрасчетный.СуммаПРКт                                    КАК СуммаПРКт,
		|	Хозрасчетный.СуммаВРДт                                    КАК СуммаВРДт,
		|	Хозрасчетный.СуммаВРКт                                    КАК СуммаВРКт,
		|	
		|	Хозрасчетный.Содержание                                   КАК Содержание,
		|	Хозрасчетный.НеКорректироватьСтоимостьАвтоматически       КАК НеКорректироватьСтоимостьАвтоматически
		|ИЗ
		|	РегистрБухгалтерии.Хозрасчетный.ДвиженияССубконто(,,Регистратор = &Ссылка,,) КАК Хозрасчетный
		|	ЛЕВОЕ СОЕДИНЕНИЕ
		|		ИзмененияСтатусов КАК ИзмененияСтатусов
		|	ПО
		|		Хозрасчетный.Организация = ИзмененияСтатусов.Организация
		|		И НАЧАЛОПЕРИОДА(Хозрасчетный.Период, ДЕНЬ) = ИзмененияСтатусов.ДатаОтражения
		|ГДЕ
		|	ИзмененияСтатусов.Организация ЕСТЬ NULL";
		#КонецОбласти
	
		Запрос.УстановитьПараметр("ТаблицаВыборочнойРегистрации", ДополнительныеСвойства.ТаблицаВыборочнойРегистрацииКОтражениюВРеглУчете);
		Результат = Запрос.ВыполнитьПакет();
		ИзмененияСтатусов = Запрос.МенеджерВременныхТаблиц.Таблицы.Получить("ИзмененияСтатусов").ПолучитьДанные().Выгрузить();
		
		ШаблонЗапретаДанных = ДатыЗапретаИзменения.ШаблонДанныхДляПроверки();
		Для каждого СтрокаОтражения Из ИзмененияСтатусов Цикл
			СтрокаШаблона = ШаблонЗапретаДанных.Добавить();
			СтрокаШаблона.Дата   = СтрокаОтражения.ДатаОтражения;
			СтрокаШаблона.Раздел = "БухгалтерскийУчет";
			СтрокаШаблона.Объект = СтрокаОтражения.Организация;
		КонецЦикла;
		
		ПроверитьДатуЗапретаДляОтраженияДокументовВРеглУчете(ШаблонЗапретаДанных, ДвиженияОтражениеДокументовВРеглУчете, Объект.Ссылка);
	
	КонецЕсли;
	
	Количество = Результат.Количество();
	
	Хозрасчетный  = Результат[Количество - 1].Выгрузить();
	ДвиженияХозрасчетный.Загрузить(Хозрасчетный);
	
	ТаблицаДанные = Результат[Количество - 2].Выгрузить();
	ДвиженияОтражениеДокументовВРеглУчете.Загрузить(ТаблицаДанные);
	
КонецПроцедуры

// Возвращает документы к отражению в регл. учете
//
// Параметры:
// 	ДокументыКОтражению -   ТаблицаЗначений, 
// 							МенеджерВременныхТаблиц - Таблица документов, которые надо вернуть к отражению, 
// 													  или менеджер временных таблиц имеющий таблицу ДокументыКОтражению
// 													  Таблица должна иметь колонки Документ, Организация, ДатаОтражения. 
//
Процедура ВернутьДокументыКОтражению(ДокументыКОтражению, КоличествоОбработанных = Неопределено) Экспорт
	
	Если Не ПолучитьФункциональнуюОпцию("ИспользоватьРеглУчет") Тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	ТекстыЗапросаПодготовкиВременныхТаблиц = Новый Массив;
	Если ТипЗнч(ДокументыКОтражению) = Тип("ТаблицаЗначений") Тогда
		Если ДокументыКОтражению.Количество() = 0 Тогда
			Возврат;
		КонецЕсли;
		ТекстЗапроса = 
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДокументыКОтражению.Документ КАК Документ,
		|	ДокументыКОтражению.Организация КАК Организация,
		|	ДокументыКОтражению.ДатаОтражения КАК ДатаОтражения
		|ПОМЕСТИТЬ ДокументыКОтражению
		|ИЗ
		|	&ДокументыКОтражению КАК ДокументыКОтражению
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Документ,
		|	Организация,
		|	ДатаОтражения";
		Запрос.УстановитьПараметр("ДокументыКОтражению", ДокументыКОтражению);
		Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
		ТекстыЗапросаПодготовкиВременныхТаблиц.Добавить(ТекстЗапроса);
		ДанныеКОтражению = ДокументыКОтражению;
	Иначе
		Запрос.МенеджерВременныхТаблиц = ДокументыКОтражению;
		ДанныеКОтражению = ДокументыКОтражению.Таблицы["ДокументыКОтражению"].ПолучитьДанные().Выгрузить();
	КонецЕсли;
	
	ШаблонЗапретаДанных = ДатыЗапретаИзменения.ШаблонДанныхДляПроверки();
	Для каждого СтрокаОтражения Из ДанныеКОтражению Цикл
		СтрокаШаблона = ШаблонЗапретаДанных.Добавить();
		СтрокаШаблона.Дата   = СтрокаОтражения.ДатаОтражения;
		СтрокаШаблона.Раздел = "БухгалтерскийУчет";
		СтрокаШаблона.Объект = СтрокаОтражения.Организация;
	КонецЦикла;
	
	ПроверитьДатуЗапретаДляОтраженияДокументовВРеглУчете(ШаблонЗапретаДанных);
	
	ТекстЗапроса = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДокументыКОтражению.Документ КАК Документ,
	|	МИНИМУМ(ДокументыКОтражению.ДатаОтражения) КАК Период
	|ПОМЕСТИТЬ ТолькоДокументыКОтражению
	|ИЗ
	|	ДокументыКОтражению КАК ДокументыКОтражению
	|ГДЕ
	|	ТИПЗНАЧЕНИЯ(ДокументыКОтражению.Документ) <> ТИП(Документ.КорректировкаРегистров)
	|
	|СГРУППИРОВАТЬ ПО
	|	ДокументыКОтражению.Документ
	|	
	|ИНДЕКСИРОВАТЬ ПО
	|	Документ";
	ТекстыЗапросаПодготовкиВременныхТаблиц.Добавить(ТекстЗапроса);
	ТекстЗапроса = 
	"ВЫБРАТЬ
	|	ОтражениеДокументовВРеглУчете.Период КАК Период,
	|	ОтражениеДокументовВРеглУчете.Регистратор КАК Регистратор,
	|	ОтражениеДокументовВРеглУчете.Организация КАК Организация,
	|	ОтражениеДокументовВРеглУчете.ДатаОтражения КАК ДатаОтражения,
	|	ОтражениеДокументовВРеглУчете.Статус,
	|	ОтражениеДокументовВРеглУчете.Комментарий
	|ПОМЕСТИТЬ ТаблицаРегистра
	|ИЗ
	|	РегистрСведений.ОтражениеДокументовВРеглУчете КАК ОтражениеДокументовВРеглУчете
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТолькоДокументыКОтражению КАК ДокументыКОтражению
	|		ПО (ДокументыКОтражению.Документ = ОтражениеДокументовВРеглУчете.Регистратор)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор,
	|	Организация,
	|	ДатаОтражения";
	ТекстыЗапросаПодготовкиВременныхТаблиц.Добавить(ТекстЗапроса);
	ТекстЗапроса = 
	"ВЫБРАТЬ
	|	ТаблицаРегистра.Регистратор КАК Регистратор,
	|	МИНИМУМ(ТаблицаРегистра.Период) КАК Период
	|ПОМЕСТИТЬ ТаблицаРегистраПервыйПериод
	|ИЗ
	|	ТаблицаРегистра КАК ТаблицаРегистра
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаРегистра.Регистратор
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор";
	ТекстыЗапросаПодготовкиВременныхТаблиц.Добавить(ТекстЗапроса);
	ТекстЗапроса = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДокументыКОтражению.Документ      КАК Документ,
	|	ДокументыКОтражению.Организация   КАК Организация,
	|	ДокументыКОтражению.ДатаОтражения КАК ДатаОтражения,
	|	ЕСТЬNULL(ОтражениеДокументовВРеглУчете.Период, ЕСТЬNULL(ТаблицаРегистраПервыйПериод.Период, ТолькоДокументыКОтражению.Период)) КАК Период
	|ПОМЕСТИТЬ ПериодыРегистрации
	|ИЗ
	|	ДокументыКОтражению КАК ДокументыКОтражению
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТолькоДокументыКОтражению КАК ТолькоДокументыКОтражению
	|		ПО (ДокументыКОтражению.Документ = ТолькоДокументыКОтражению.Документ)
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		ТаблицаРегистра КАК ОтражениеДокументовВРеглУчете
	|	ПО
	|		ДокументыКОтражению.Документ = ОтражениеДокументовВРеглУчете.Регистратор
	|		И ДокументыКОтражению.Организация = ОтражениеДокументовВРеглУчете.Организация
	|		И ДокументыКОтражению.ДатаОтражения = ОтражениеДокументовВРеглУчете.ДатаОтражения
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		ТаблицаРегистраПервыйПериод КАК ТаблицаРегистраПервыйПериод
	|	ПО
	|		ДокументыКОтражению.Документ = ТаблицаРегистраПервыйПериод.Регистратор
	|	
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументыКОтражению.Документ,
	|	ДокументыКОтражению.Организация,
	|	ДокументыКОтражению.ДатаОтражения";
	ТекстыЗапросаПодготовкиВременныхТаблиц.Добавить(ТекстЗапроса);
	
	ТекстыЗапросаВыборки = Новый Массив;
	ТекстЗапроса = 
	"ВЫБРАТЬ
	|	ОтражениеДокументовВРеглУчете.Период         КАК Период,
	|	ОтражениеДокументовВРеглУчете.Регистратор    КАК Регистратор,
	|	ОтражениеДокументовВРеглУчете.Организация    КАК Организация,
	|	ОтражениеДокументовВРеглУчете.ДатаОтражения  КАК ДатаОтражения,
	|	ВЫБОР 
	|		КОГДА НЕ ДокументыКОтражению.Организация ЕСТЬ NULL ТОГДА
	|			ВЫБОР КОГДА ОтражениеДокументовВРеглУчете.Статус В (
	|					ЗНАЧЕНИЕ(Перечисление.СтатусыОтраженияДокументовВРеглУчете.ОтраженоВУчетеВручную),
	|					ЗНАЧЕНИЕ(Перечисление.СтатусыОтраженияДокументовВРеглУчете.КОтражениюВУчетеВручную))
	|				ТОГДА ЗНАЧЕНИЕ(Перечисление.СтатусыОтраженияДокументовВРеглУчете.КОтражениюВУчетеВручную)
	|				ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.СтатусыОтраженияДокументовВРеглУчете.КОтражениюВРеглУчете)
	|			КОНЕЦ
	|		ИНАЧЕ ОтражениеДокументовВРеглУчете.Статус
	|	КОНЕЦ КАК Статус,
	|	ВЫБОР
	|		КОГДА НЕ ДокументыКОтражению.Организация ЕСТЬ NULL ТОГДА
	|			ВЫБОР КОГДА ОтражениеДокументовВРеглУчете.Статус В (
	|					ЗНАЧЕНИЕ(Перечисление.СтатусыОтраженияДокументовВРеглУчете.ОтраженоВУчетеВручную),
	|					ЗНАЧЕНИЕ(Перечисление.СтатусыОтраженияДокументовВРеглУчете.КОтражениюВУчетеВручную))
	|				ТОГДА ОтражениеДокументовВРеглУчете.Комментарий
	|				ИНАЧЕ """"
	|			КОНЕЦ
	|		ИНАЧЕ ОтражениеДокументовВРеглУчете.Комментарий
	|	КОНЕЦ КАК Комментарий,
	|	НЕ ДокументыКОтражению.Организация ЕСТЬ NULL
	|		И ОтражениеДокументовВРеглУчете.Статус В (ЗНАЧЕНИЕ(Перечисление.СтатусыОтраженияДокументовВРеглУчете.ОтраженоВУчетеВручную),
	|			ЗНАЧЕНИЕ(Перечисление.СтатусыОтраженияДокументовВРеглУчете.НеУказаныСчетаУчета),
	|			ЗНАЧЕНИЕ(Перечисление.СтатусыОтраженияДокументовВРеглУчете.ОтраженоВРеглУчете)) КАК ЕстьИзменения
	|ИЗ
	|	ТаблицаРегистра КАК ОтражениеДокументовВРеглУчете
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		ПериодыРегистрации КАК ДокументыКОтражению
	|	ПО
	|		ДокументыКОтражению.Документ = ОтражениеДокументовВРеглУчете.Регистратор
	|		И ДокументыКОтражению.Организация = ОтражениеДокументовВРеглУчете.Организация
	|		И ДокументыКОтражению.ДатаОтражения = ОтражениеДокументовВРеглУчете.ДатаОтражения
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Константы КАК Константы
	|		ПО (ИСТИНА)
	|
	|ГДЕ
	|	ОтражениеДокументовВРеглУчете.Организация <> ЗНАЧЕНИЕ(Справочник.Организации.УправленческаяОрганизация)
	|	И (ОтражениеДокументовВРеглУчете.ДатаОтражения >= Константы.ДатаНачалаВеденияРеглУчета)";
	ДобавитьВЗапросФильтрОтраженияВРеглУчете(ТекстЗапроса, "ОтражениеДокументовВРеглУчете.Регистратор");
	ТекстыЗапросаВыборки.Добавить(ТекстЗапроса);
	ТекстЗапроса = 
	"ВЫБРАТЬ
	|	ДокументыКОтражению.Период          КАК Период,
	|	ДокументыКОтражению.Документ       КАК Регистратор,
	|	ДокументыКОтражению.Организация    КАК Организация,
	|	ДокументыКОтражению.ДатаОтражения  КАК ДатаОтражения,
	|	ЗНАЧЕНИЕ(Перечисление.СтатусыОтраженияДокументовВРеглУчете.КОтражениюВРеглУчете) КАК Статус,
	|	"""" КАК Комментарий,
	|	ИСТИНА
	|ИЗ
	|	ПериодыРегистрации КАК ДокументыКОтражению
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		ТаблицаРегистра КАК ОтражениеДокументовВРеглУчете
	|	ПО
	|		ДокументыКОтражению.Документ = ОтражениеДокументовВРеглУчете.Регистратор
	|		И ДокументыКОтражению.Организация = ОтражениеДокументовВРеглУчете.Организация
	|		И ДокументыКОтражению.ДатаОтражения = ОтражениеДокументовВРеглУчете.ДатаОтражения
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Константы КАК Константы
	|		ПО (ИСТИНА)
	|
	|ГДЕ
	|	ДокументыКОтражению.Организация <> ЗНАЧЕНИЕ(Справочник.Организации.УправленческаяОрганизация)
	|	И ТИПЗНАЧЕНИЯ(ДокументыКОтражению.Документ) <> ТИП(Документ.КорректировкаРегистров)
	|	И ОтражениеДокументовВРеглУчете.Регистратор ЕСТЬ NULL
	|	И (ДокументыКОтражению.ДатаОтражения >= Константы.ДатаНачалаВеденияРеглУчета)
	|	
	|ИТОГИ
	|	МАКСИМУМ(ЕстьИзменения)
	|ПО
	|	Регистратор";
	ДобавитьВЗапросФильтрОтраженияВРеглУчете(ТекстЗапроса, "ДокументыКОтражению.Документ");
	ТекстыЗапросаВыборки.Добавить(ТекстЗапроса);
	
	ТекстЗапроса = СтрСоединить(ТекстыЗапросаВыборки, ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении());
	ТекстыЗапросаПодготовкиВременныхТаблиц.Добавить(ТекстЗапроса);
	Запрос.Текст = СтрСоединить(ТекстыЗапросаПодготовкиВременныхТаблиц, ОбщегоНазначения.РазделительПакетаЗапросов());
	
	Результат = Запрос.Выполнить();
	ВыборкаПоДокументам = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	ТипыДокументовКОтражению = Метаданные.РегистрыСведений.ОтражениеДокументовВРеглУчете.СтандартныеРеквизиты.Регистратор.Тип;
	Пока ВыборкаПоДокументам.Следующий() Цикл
		Если ТипыДокументовКОтражению.СодержитТип(ТипЗнч(ВыборкаПоДокументам.Регистратор)) И ВыборкаПоДокументам.ЕстьИзменения Тогда
			НаборЗаписей = РегистрыСведений.ОтражениеДокументовВРеглУчете.СоздатьНаборЗаписей();
			НаборЗаписей.ДополнительныеСвойства.Вставить("ПроверкаДатыЗапретаИзменения", Ложь);
			НаборЗаписей.Отбор.Регистратор.Установить(ВыборкаПоДокументам.Регистратор);
			Выборка = ВыборкаПоДокументам.Выбрать();
			Пока Выборка.Следующий() Цикл
				НоваяЗапись = НаборЗаписей.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяЗапись, Выборка);
			КонецЦикла;
			НаборЗаписей.Записать();
			Если ТипЗнч(КоличествоОбработанных) = Тип("Число") Тогда
				КоличествоОбработанных = КоличествоОбработанных + 1;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	СписокТаблицДляУничтожения = "ПериодыРегистрации,ТолькоДокументыКОтражению,ТаблицаРегистра,ТаблицаРегистраПервыйПериод";
	ОбщегоНазначенияУТ.УничтожитьВременныеТаблицы(Запрос.МенеджерВременныхТаблиц, СписокТаблицДляУничтожения);
	
КонецПроцедуры

// Записывает движения по регистру ОтражениеДокументаВРеглУчете, выполняет очистку неактуальных записей в Хозрасчетный.
// Вызывается из оффлайновых общих модулей НДС.
//
// Параметры:
// 	МенеджерВременныхТаблиц - МенеджерВременныхТаблиц - менеджер временных таблиц, имеющий таблицы
// 		ТаблицаТекущейРегистрации и ТаблицаВыборочнойРегистрации.
// 		Таблицы должны иметь колонки Документ, Организация, ДатаОтражения.
//
Процедура ВернутьДокументыКОтражениюВыборочноПакетно(МенеджерВременныхТаблиц, КоличествоОбработанных = Неопределено) Экспорт
	
	Если Не ПолучитьФункциональнуюОпцию("ИспользоватьРеглУчет") Тогда
	 	Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	
	#Область ТекстЗапроса
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ТаблицаТекущейРегистрации.Документ КАК Документ
	|ПОМЕСТИТЬ ТолькоДокументыКОтражению
	|ИЗ
	|	ТаблицаТекущейРегистрации КАК ТаблицаТекущейРегистрации
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОтражениеДокументов.Период КАК Период,
	|	ОтражениеДокументов.Регистратор КАК Документ,
	|	ОтражениеДокументов.Организация КАК Организация,
	|	ОтражениеДокументов.ДатаОтражения КАК ДатаОтражения,
	|	ОтражениеДокументов.Статус КАК Статус,
	|	ОтражениеДокументов.Комментарий КАК Комментарий
	|ПОМЕСТИТЬ ТекущиеСтатусы
	|ИЗ
	|	РегистрСведений.ОтражениеДокументовВРеглУчете КАК ОтражениеДокументов
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТолькоДокументыКОтражению КАК ТолькоДокументыКОтражению
	|		ПО ОтражениеДокументов.Регистратор = ТолькоДокументыКОтражению.Документ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаВыборочнойРегистрации.Документ КАК Документ,
	|	МИНИМУМ(ТаблицаВыборочнойРегистрации.ДатаОтражения) КАК ДатаОтражения
	|ПОМЕСТИТЬ НачалоИзмененийВыборочнойРегистрации
	|ИЗ
	|	ТаблицаВыборочнойРегистрации КАК ТаблицаВыборочнойРегистрации
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаВыборочнойРегистрации.Документ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЕСТЬNULL(ТекущиеСтатусы.Период, ТаблицаТекущейРегистрации.Период) КАК Период,
	|	ТаблицаТекущейРегистрации.Документ КАК Документ,
	|	ТаблицаТекущейРегистрации.Организация КАК Организация,
	|	ТаблицаТекущейРегистрации.ДатаОтражения КАК ДатаОтражения,
	|	ВЫБОР
	|		КОГДА ТаблицаВыборочнойРегистрации.ДатаОтражения ЕСТЬ NULL
	|				И НЕ ТекущиеСтатусы.Статус ЕСТЬ NULL
	|			ТОГДА ТекущиеСтатусы.Статус
	|		КОГДА ЕСТЬNULL(ТекущиеСтатусы.Статус, НЕОПРЕДЕЛЕНО) В (&ОтраженоВУчетеВручную, &КОтражениюВУчетеВручную)
	|			ТОГДА &КОтражениюВУчетеВручную
	|		ИНАЧЕ &КОтражениюВРеглУчете
	|	КОНЕЦ КАК Статус,
	|	ВЫБОР
	|		КОГДА ТаблицаВыборочнойРегистрации.ДатаОтражения ЕСТЬ NULL
	|			ТОГДА ТекущиеСтатусы.Комментарий
	|		КОГДА ЕСТЬNULL(ТекущиеСтатусы.Статус, НЕОПРЕДЕЛЕНО) В (&ОтраженоВУчетеВручную, &КОтражениюВУчетеВручную)
	|			ТОГДА ТекущиеСтатусы.Комментарий
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК Комментарий
	|ПОМЕСТИТЬ НовыеСтатусы
	|ИЗ
	|	ТаблицаТекущейРегистрации КАК ТаблицаТекущейРегистрации
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТекущиеСтатусы КАК ТекущиеСтатусы
	|		ПО ТаблицаТекущейРегистрации.Документ = ТекущиеСтатусы.Документ
	|			И ТаблицаТекущейРегистрации.Организация = ТекущиеСтатусы.Организация
	|			И ТаблицаТекущейРегистрации.ДатаОтражения = ТекущиеСтатусы.ДатаОтражения
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаВыборочнойРегистрации КАК ТаблицаВыборочнойРегистрации
	|		ПО ТаблицаТекущейРегистрации.Документ = ТаблицаВыборочнойРегистрации.Документ
	|			И ТаблицаТекущейРегистрации.Организация = ТаблицаВыборочнойРегистрации.Организация
	|			И ТаблицаТекущейРегистрации.ДатаОтражения = ТаблицаВыборочнойРегистрации.ДатаОтражения
	|ГДЕ
	|	ТаблицаВыборочнойРегистрации.ДатаОтражения ЕСТЬ NULL
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Таблица.Документ КАК Документ,
	|	Таблица.Организация КАК Организация,
	|	Таблица.ДатаОтражения КАК ДатаОтражения
	|ПОМЕСТИТЬ ИзмененияСтатусов
	|ИЗ
	|	(ВЫБРАТЬ
	|		Таблица.Документ КАК Документ,
	|		Таблица.ДатаОтражения КАК ДатаОтражения,
	|		Таблица.Организация КАК Организация,
	|		ВЫБОР
	|			КОГДА Таблица.Статус = &КОтражениюВРеглУчете
	|				ТОГДА 1
	|			КОГДА Таблица.Статус = &ОтраженоВРеглУчете
	|				ТОГДА 2
	|		КОНЕЦ КАК Статус
	|	ИЗ
	|		НовыеСтатусы КАК Таблица
	|	ГДЕ
	|		Таблица.Статус В (&КОтражениюВРеглУчете, &ОтраженоВРеглУчете)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Таблица.Документ,
	|		Таблица.ДатаОтражения,
	|		Таблица.Организация,
	|		ВЫБОР
	|			КОГДА Таблица.Статус = &КОтражениюВРеглУчете
	|				ТОГДА -1
	|			КОГДА Таблица.Статус = &ОтраженоВРеглУчете
	|				ТОГДА -2
	|		КОНЕЦ
	|	ИЗ
	|		ТекущиеСтатусы КАК Таблица
	|	ГДЕ
	|		Таблица.Статус В (&КОтражениюВРеглУчете, &ОтраженоВРеглУчете)) КАК Таблица
	|		ЛЕВОЕ СОЕДИНЕНИЕ НачалоИзмененийВыборочнойРегистрации КАК НачалоИзменений
	|		ПО Таблица.Документ = НачалоИзменений.Документ
	|ГДЕ
	|	Таблица.ДатаОтражения >= ЕСТЬNULL(НАЧАЛОПЕРИОДА(НачалоИзменений.ДатаОтражения, МЕСЯЦ), ДАТАВРЕМЯ(1, 1, 1))
	|
	|СГРУППИРОВАТЬ ПО
	|	Таблица.Документ,
	|	Таблица.ДатаОтражения,
	|	Таблица.Организация
	|
	|ИМЕЮЩИЕ
	|	СУММА(Таблица.Статус) <> 0
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Таблица.Документ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	НовыеСтатусы.Период КАК Период,
	|	НовыеСтатусы.Документ КАК Документ,
	|	НовыеСтатусы.Организация КАК Организация,
	|	НовыеСтатусы.ДатаОтражения КАК ДатаОтражения,
	|	НовыеСтатусы.Статус КАК Статус,
	|	НовыеСтатусы.Комментарий КАК Комментарий
	|ИЗ
	|	НовыеСтатусы КАК НовыеСтатусы
	|
	|УПОРЯДОЧИТЬ ПО
	|	ДатаОтражения
	|ИТОГИ ПО
	|	Документ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Хозрасчетный.Период КАК Период,
	|	Хозрасчетный.Регистратор КАК Регистратор,
	|	Хозрасчетный.Организация КАК Организация,
	|	Хозрасчетный.ПодразделениеДт КАК ПодразделениеДт,
	|	Хозрасчетный.НаправлениеДеятельностиДт КАК НаправлениеДеятельностиДт,
	|	Хозрасчетный.СчетДт КАК СчетДт,
	|	ЕСТЬNULL(Хозрасчетный.ВидСубконтоДт1, &ПустойВидСубконто) КАК ВидСубконтоДт1,
	|	ЕСТЬNULL(Хозрасчетный.СубконтоДт1, НЕОПРЕДЕЛЕНО) КАК СубконтоДт1,
	|	ЕСТЬNULL(Хозрасчетный.ВидСубконтоДт2, &ПустойВидСубконто) КАК ВидСубконтоДт2,
	|	ЕСТЬNULL(Хозрасчетный.СубконтоДт2, НЕОПРЕДЕЛЕНО) КАК СубконтоДт2,
	|	ЕСТЬNULL(Хозрасчетный.ВидСубконтоДт3, &ПустойВидСубконто) КАК ВидСубконтоДт3,
	|	ЕСТЬNULL(Хозрасчетный.СубконтоДт3, НЕОПРЕДЕЛЕНО) КАК СубконтоДт3,
	|	Хозрасчетный.ВалютаДт КАК ВалютаДт,
	|	Хозрасчетный.ВалютнаяСуммаДт КАК ВалютнаяСуммаДт,
	|	Хозрасчетный.КоличествоДт КАК КоличествоДт,
	|	Хозрасчетный.ПодразделениеКт КАК ПодразделениеКт,
	|	Хозрасчетный.НаправлениеДеятельностиКт КАК НаправлениеДеятельностиКт,
	|	Хозрасчетный.СчетКт КАК СчетКт,
	|	ЕСТЬNULL(Хозрасчетный.ВидСубконтоКт1, &ПустойВидСубконто) КАК ВидСубконтоКт1,
	|	ЕСТЬNULL(Хозрасчетный.СубконтоКт1, НЕОПРЕДЕЛЕНО) КАК СубконтоКт1,
	|	ЕСТЬNULL(Хозрасчетный.ВидСубконтоКт2, &ПустойВидСубконто) КАК ВидСубконтоКт2,
	|	ЕСТЬNULL(Хозрасчетный.СубконтоКт2, НЕОПРЕДЕЛЕНО) КАК СубконтоКт2,
	|	ЕСТЬNULL(Хозрасчетный.ВидСубконтоКт3, &ПустойВидСубконто) КАК ВидСубконтоКт3,
	|	ЕСТЬNULL(Хозрасчетный.СубконтоКт3, НЕОПРЕДЕЛЕНО) КАК СубконтоКт3,
	|	Хозрасчетный.ВалютаКт КАК ВалютаКт,
	|	Хозрасчетный.ВалютнаяСуммаКт КАК ВалютнаяСуммаКт,
	|	Хозрасчетный.КоличествоКт КАК КоличествоКт,
	|	Хозрасчетный.Сумма КАК Сумма,
	|	Хозрасчетный.СуммаУУ КАК СуммаУУ,
	|	Хозрасчетный.СуммаФО КАК СуммаФО,
	|	Хозрасчетный.СуммаНУДт КАК СуммаНУДт,
	|	Хозрасчетный.СуммаНУКт КАК СуммаНУКт,
	|	Хозрасчетный.СуммаПРДт КАК СуммаПРДт,
	|	Хозрасчетный.СуммаПРКт КАК СуммаПРКт,
	|	Хозрасчетный.СуммаВРДт КАК СуммаВРДт,
	|	Хозрасчетный.СуммаВРКт КАК СуммаВРКт,
	|	Хозрасчетный.Содержание КАК Содержание,
	|	Хозрасчетный.НеКорректироватьСтоимостьАвтоматически КАК НеКорректироватьСтоимостьАвтоматически
	|ИЗ
	|	РегистрБухгалтерии.Хозрасчетный.ДвиженияССубконто(
	|			,
	|			,
	|			Регистратор В
	|				(ВЫБРАТЬ
	|					Т.Документ
	|				ИЗ
	|					ТолькоДокументыКОтражению КАК Т),
	|			,
	|			) КАК Хозрасчетный
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИзмененияСтатусов КАК ИзмененияСтатусов
	|		ПО Хозрасчетный.Регистратор = ИзмененияСтатусов.Документ
	|			И Хозрасчетный.Организация = ИзмененияСтатусов.Организация
	|			И (НАЧАЛОПЕРИОДА(Хозрасчетный.Период, ДЕНЬ) = ИзмененияСтатусов.ДатаОтражения)
	|ГДЕ
	|	ИзмененияСтатусов.Организация ЕСТЬ NULL";
	#КонецОбласти
	
	Запрос.УстановитьПараметр("ПустойВидСубконто",  ПланыВидовХарактеристик.ВидыСубконтоХозрасчетные.ПустаяСсылка());
	
	Запрос.УстановитьПараметр("ОтраженоВРеглУчете",      Перечисления.СтатусыОтраженияДокументовВРеглУчете.ОтраженоВРеглУчете);
	Запрос.УстановитьПараметр("КОтражениюВРеглУчете",    Перечисления.СтатусыОтраженияДокументовВРеглУчете.КОтражениюВРеглУчете);
	Запрос.УстановитьПараметр("ОтраженоВУчетеВручную",   Перечисления.СтатусыОтраженияДокументовВРеглУчете.ОтраженоВУчетеВручную);
	Запрос.УстановитьПараметр("КОтражениюВУчетеВручную", Перечисления.СтатусыОтраженияДокументовВРеглУчете.КОтражениюВУчетеВручную);
	
	Результат = Запрос.ВыполнитьПакет();
	Количество = Результат.Количество();
	
	ИзмененияСтатусов = Запрос.МенеджерВременныхТаблиц.Таблицы.Получить("ИзмененияСтатусов").ПолучитьДанные().Выгрузить();
	
	ШаблонЗапретаДанных = ДатыЗапретаИзменения.ШаблонДанныхДляПроверки();
	Для Каждого СтрокаОтражения Из ИзмененияСтатусов Цикл
		СтрокаШаблона = ШаблонЗапретаДанных.Добавить();
		СтрокаШаблона.Дата   = СтрокаОтражения.ДатаОтражения;
		СтрокаШаблона.Раздел = "БухгалтерскийУчет";
		СтрокаШаблона.Объект = СтрокаОтражения.Организация;
	КонецЦикла;
	
	ПроверитьДатуЗапретаДляОтраженияДокументовВРеглУчете(ШаблонЗапретаДанных);
	
	Хозрасчетный = Результат[Количество - 1].Выгрузить();
	Хозрасчетный.Индексы.Добавить("Регистратор");
	
	ВыборкаПоДокументам = Результат[Количество - 2].Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	ТипыДокументовКОтражению = Метаданные.РегистрыСведений.ОтражениеДокументовВРеглУчете.СтандартныеРеквизиты.Регистратор.Тип;
	Пока ВыборкаПоДокументам.Следующий() Цикл
		ДвиженияХозрасчетный = РегистрыБухгалтерии.Хозрасчетный.СоздатьНаборЗаписей();
		ДвиженияХозрасчетный.Отбор.Регистратор.Установить(ВыборкаПоДокументам.Документ);
		УстановитьДопСвойстваНабораЗаписейХозрасчетный(ДвиженияХозрасчетный, ВыборкаПоДокументам.Документ);
		ДвиженияХозрасчетный.Записывать = Истина;
		
		ХозрасчетныйПоДокументу = Хозрасчетный.СкопироватьКолонки();
		НайденныеСтроки = Хозрасчетный.НайтиСтроки(Новый Структура("Регистратор", ВыборкаПоДокументам.Документ));
		Для Каждого НайденнаяСтрока Из НайденныеСтроки Цикл
			НоваяСтрока = ХозрасчетныйПоДокументу.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, НайденнаяСтрока);
		КонецЦикла;
		
		ДвиженияХозрасчетный.Загрузить(ХозрасчетныйПоДокументу);
		ДвиженияХозрасчетный.Записать();
		
		ЕстьИзменения = Не ИзмененияСтатусов.Найти(ВыборкаПоДокументам.Документ, "Документ") = Неопределено;
		Если ТипыДокументовКОтражению.СодержитТип(ТипЗнч(ВыборкаПоДокументам.Документ)) И ЕстьИзменения Тогда
			НаборЗаписей = РегистрыСведений.ОтражениеДокументовВРеглУчете.СоздатьНаборЗаписей();
			НаборЗаписей.ДополнительныеСвойства.Вставить("ПроверкаДатыЗапретаИзменения", Ложь);
			НаборЗаписей.Отбор.Регистратор.Установить(ВыборкаПоДокументам.Документ);
			
			Выборка = ВыборкаПоДокументам.Выбрать();
			Пока Выборка.Следующий() Цикл
				НоваяЗапись = НаборЗаписей.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяЗапись, Выборка);
			КонецЦикла;
			
			НаборЗаписей.Записать();
			Если ТипЗнч(КоличествоОбработанных) = Тип("Число") Тогда
				КоличествоОбработанных = КоличествоОбработанных + 1;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	СписокТаблицДляУничтожения = "ТолькоДокументыКОтражению,НачалоИзмененийВыборочнойРегистрации,ТекущиеСтатусы,НовыеСтатусы,ИзмененияСтатусов";
	ОбщегоНазначенияУТ.УничтожитьВременныеТаблицы(Запрос.МенеджерВременныхТаблиц, СписокТаблицДляУничтожения);
	
КонецПроцедуры

// Записывает движения по регистру ПорядокОтраженияПрочихОпераций. 
// Оставлена для совместимости со старым подходом настройки отражения прочих операций.
// 
// Параметры:
// 	 ДополнительныеСвойства - Структура - Содержит таблицу с порядком регистрации прочих операций.
// 	 Отказ - Булево - Отказ проведения документа.
//
Процедура ОтразитьПорядокОтраженияПрочихОпераций(ДополнительныеСвойства, Отказ) Экспорт
	
	Если Отказ Тогда
		Возврат;
	КонецЕсли;
	
	Документ = ДополнительныеСвойства.ДляПроведения.Ссылка;
	
	ТаблицаПорядокОтраженияПрочихОпераций = Неопределено;
	Если Не ДополнительныеСвойства.ТаблицыДляДвижений.Свойство("ТаблицаПорядокОтраженияПрочихОпераций", ТаблицаПорядокОтраженияПрочихОпераций)
		И Не ДополнительныеСвойства.ТаблицыДляДвижений.Свойство("ПорядокОтраженияПрочихОпераций", ТаблицаПорядокОтраженияПрочихОпераций) Тогда
		Возврат;
	КонецЕсли;
	
	// Если параметры отражения заданы в документе (списание безналичных ДС),
	// то ТаблицаПорядокОтраженияПрочихОпераций содержит готовые данные для отражения.
	Если ДополнительныеСвойства.Свойство("ПараметрыОтраженияВРеглУчете") Тогда
		
		ПараметрыОтраженияВРеглУчете = ТаблицаПорядокОтраженияПрочихОпераций;
		
	Иначе
		
		Запрос = Новый Запрос("
		|ВЫБРАТЬ
		|	Операция.Документ,
		|	Операция.ИдентификаторСтроки,
		|	Операция.Организация,
		|	Операция.Дата
		|ПОМЕСТИТЬ
		|	Операция
		|ИЗ &Таблица КАК Операция;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Операция.Документ,
		|	Операция.ИдентификаторСтроки,
		|	Операция.Организация,
		|   Операция.Дата,
		|	Счета.СчетУчета КАК СчетУчета,
		|	Счета.Субконто1 КАК Субконто1,
		|	Счета.Субконто2 КАК Субконто2,
		|	Счета.Субконто3 КАК Субконто3
		|ИЗ
		|	Операция
		|	ПОЛНОЕ СОЕДИНЕНИЕ РегистрСведений.ПорядокОтраженияПрочихОпераций КАК Счета
		|		ПО Счета.Документ = Операция.Документ И Счета.ИдентификаторСтроки = Операция.ИдентификаторСтроки
		|ГДЕ
		|	НЕ Операция.Документ ЕСТЬ NULL
		|");
		Запрос.УстановитьПараметр("Таблица", ТаблицаПорядокОтраженияПрочихОпераций);
		Запрос.УстановитьПараметр("Документ", Документ);
		
		ПараметрыОтраженияВРеглУчете = Запрос.Выполнить().Выгрузить();
		
	КонецЕсли;
	
	НаборЗаписей = РегистрыСведений.ПорядокОтраженияПрочихОпераций.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.Документ.Установить(Документ);
	НаборЗаписей.Загрузить(ПараметрыОтраженияВРеглУчете);
	НаборЗаписей.Записывать = Истина;
	НаборЗаписей.Записать();
	
КонецПроцедуры

// Проверяет переданные документы на факт отражения ОтразитьДокументов регл. учете при наличии прав на формирование проводок.
//
// Параметры:
//    МассивДокументов - Массив - Документы.
//
// Возвращаемое значение:
//    Массив - Документы, которые не отражены в регл. учете.
//
Функция ПроверитьПраваДоступаОтражениеДокументовВРеглУчете(МассивДокументов) Экспорт
	
	Если ПравоДоступа("Редактирование", Метаданные.РегистрыБухгалтерии.Хозрасчетный)
		И ПолучитьФункциональнуюОпцию("ИспользоватьРеглУчет") Тогда
		Возврат НеотраженныеВРеглУчетеДокументы(МассивДокументов);
	Иначе
		Возврат Новый Массив;
	КонецЕсли;
	
КонецФункции

// Получает результат отражения в регл. учете. Результат помещается во временное хранилище.
//
// Параметры:
//		ПараметрыОтражения - Структура - параметров отражения, где:
//			* Ссылка - ДокументСсылка - документ, для которого надо получить таблицу проводок;
//			* Дата - дата документа;
//			* Организация - ОрганизацияСсылка - организация, по которой получается таблица проводок;
//			* ВыполнитьПересчеты - булево, флажок о том, необходимо ли перед формированием проводок выполнять оффлайновые пересчеты по документу
// 		АдресРезультата - Строка - Адрес временного хранилища для помещения результата.
//
Процедура ВернутьРезультатОтраженияДокумента(ПараметрыОтражения, АдресРезультата) Экспорт
	
	Если НЕ ПолучитьФункциональнуюОпцию("ИспользоватьРеглУчет") Тогда
		СтруктураВозврата = Новый Структура("ТаблицаПроводок, КомментарийОшибки", Новый ТаблицаЗначений, "");
		ПоместитьВоВременноеХранилище(СтруктураВозврата, АдресРезультата);
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Истина);
	
	Если ПараметрыОтражения.ВыполнитьПересчеты Тогда
		ВыполнитьОффлайновыеРасчеты(ПараметрыОтражения.Ссылка);
	КонецЕсли;
	
	ВременныеТаблицы = ВременныеТаблицы();
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = ВременныеТаблицы;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Данные.Регистратор                  КАК Ссылка,
	|	Данные.Период                       КАК Период,
	|	Данные.Организация                  КАК Организация,
	|	Данные.ДатаОтражения               КАК ДатаОтражения
	|ПОМЕСТИТЬ РазрезыКОтражению
	|ИЗ
	|	РегистрСведений.ОтражениеДокументовВРеглУчете КАК Данные
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Константы КАК Константы
	|		ПО (ИСТИНА)
	|ГДЕ
	|	Данные.Регистратор = &Ссылка
	|	И (Данные.ДатаОтражения >= Константы.ДатаНачалаВеденияРеглУчета)
	|;
	|
	|//////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	РазрезыКОтражению.Ссылка КАК Ссылка,
	|	РазрезыКОтражению.Период КАК Период
	|ПОМЕСТИТЬ ДокументыКОтражению
	|ИЗ
	|	РазрезыКОтражению КАК РазрезыКОтражению
	|";
	Запрос.УстановитьПараметр("Ссылка",            ПараметрыОтражения.Ссылка);
	ДобавитьВЗапросФильтрОтраженияВРеглУчете(Запрос.Текст, "Данные.Регистратор");
	Запрос.Выполнить();
	
	ТипДокумента = ТипЗнч(ПараметрыОтражения.Ссылка);
	МетаданныеДокумента = Метаданные.НайтиПоТипу(ТипДокумента);
	ИмяДокумента = МетаданныеДокумента.Имя;
	
	Результат = ВыборкиОтраженияДокументов(ИмяДокумента, ВременныеТаблицы);
	
	СтруктураВозврата = Новый Структура("ТаблицаПроводок, КомментарийОшибки, СтатусОтражения");
	
	Если Результат.ВыборкаСтатусов.Следующий() Тогда
		
		Результат.ВыборкаХозрасчетный.Следующий();
		СтруктураВозврата.ТаблицаПроводок = ТаблицаПроводок();
		ДобавитьСтрокиВТаблицуПроводок(СтруктураВозврата.ТаблицаПроводок, Результат.ВыборкаХозрасчетный);
		СтруктураВозврата.КомментарийОшибки = "";
		СтруктураВозврата.СтатусОтражения = Перечисления.СтатусыОтраженияДокументовВРеглУчете.ОтраженоВРеглУчете;
		
		Если Результат.ВыборкаПроверки.Следующий() Тогда
			СтруктураВозврата.КомментарийОшибки = КомментарийОшибокЗаполнения(Результат.ВыборкаПроверки);
			СтруктураВозврата.СтатусОтражения = Перечисления.СтатусыОтраженияДокументовВРеглУчете.НеУказаныСчетаУчета;
		КонецЕсли;
		
	КонецЕсли;
	
	ВременныеТаблицы.Закрыть();
	
	ПоместитьВоВременноеХранилище(СтруктураВозврата, АдресРезультата);
	
КонецПроцедуры

// Записывает статус отражения документа в регистре сведений "ОтражениеДокументовВРеглУчете" как ОтраженоВУчетеВручную.
//
//	Параметры:
//		Документ - ДокументСсылка - ссылка на документ, для которого должен быть записан статус ручного отражения. Если ссылка - пустая, записи не происходит.
//		СтатусОтражения - ПеречислениеСсылка.СтатусыОтраженияДокументовВРеглУчете - статус, который будет установлен после выполнения процедуры.
//		Комментарий - строка - дополнительные сведения о ручном отражении документа.
//		ТаблицаОтражения - Таблица значений - если документ ранее не был отражен, выполняет отражение документа по этой таблице. Таблица значений с колонками:
//			* Период - дата отражения,
//			* Регистратор - отражаемый документ,
//			* Организация - организация по которой происходит отражение.
//
Процедура ЗарегистрироватьОтражениеДокумента(Документ, СтатусОтражения, Комментарий = Неопределено, ТаблицаОтражения = Неопределено) Экспорт
	
	Если Документ.Пустая() ИЛИ Не ПолучитьФункциональнуюОпцию("ИспользоватьРеглУчет") Тогда
		Возврат;
	КонецЕсли;
	
	НачатьТранзакцию();
	
	Попытка
		
		ПараметрыБлокировки	= Новый Структура("ТипТаблицы, ИмяТаблицы", "РегистрСведений", "ОтражениеДокументовВРеглУчете.НаборЗаписей");
		ЗначенияБлокировки	= Новый Структура("Регистратор", Документ);
		ОбщегоНазначенияБПВызовСервера.УстановитьУправляемуюБлокировку(ПараметрыБлокировки, ЗначенияБлокировки);
		
		ОтражениеДокументовВРегламентированномУчете = РегистрыСведений.ОтражениеДокументовВРеглУчете.СоздатьНаборЗаписей();
		ОтражениеДокументовВРегламентированномУчете.Отбор.Регистратор.Установить(Документ);
		ОтражениеДокументовВРегламентированномУчете.Прочитать();
		
		Если Не ОтражениеДокументовВРегламентированномУчете.Количество() И ТаблицаОтражения <> Неопределено Тогда
			ДатаОтраженияРеглУчета = Константы.ДатаНачалаВеденияРеглУчета.Получить();
			Для каждого СтрокаИсточник из ТаблицаОтражения Цикл
				СтрокаПриемник = ОтражениеДокументовВРегламентированномУчете.Добавить();
				ЗаполнитьЗначенияСвойств(СтрокаПриемник, СтрокаИсточник);
				СтрокаПриемник.ДатаОтражения = ?(СтрокаИсточник.Период >= ДатаОтраженияРеглУчета, СтрокаИсточник.Период, ДатаОтраженияРеглУчета);
			КонецЦикла;
		КонецЕсли;
		
		Для каждого Запись Из ОтражениеДокументовВРегламентированномУчете Цикл
			
			Запись.Статус = СтатусОтражения;
			
			Если Не Запись.Комментарий = Комментарий Тогда
				Запись.Комментарий = Комментарий;
			КонецЕсли;
			
		КонецЦикла;
		
		ОтражениеДокументовВРегламентированномУчете.Записать();
	
		ЗафиксироватьТранзакцию();
		
	Исключение
		
		ОтменитьТранзакцию();
		ОписаниеОшибки = СтрШаблон(
					НСтр("ru = 'Не удалось установить статус отражения в учете ""%1"" для документа ""%2"" по причине: %3'"),
					СтатусОтражения,
					Документ,
					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		ЗаписьЖурналаРегистрации(
			НСтр("ru = 'Установка нового статуса отражения в учете'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()),
			УровеньЖурналаРегистрации.Ошибка,
			Документ.Метаданные(),
			Документ,
			ОписаниеОшибки);
			
	КонецПопытки;
	
КонецПроцедуры

// Получает данные об отражении документа в регламентированном учете. Причем получает в определенном порядке. 
//
//	Параметры:
//		Документ - ДокументСсылка - ссылка на документ, для которого необходимо получить данные отражения.
//		Организация - СправочникСсылка.Организации, Массив Из СправочникСсылка.Организации, Неопределено -
//
//	Возвращаемое значение:
//		Структура - содержит следующие данные:
//			* Статус - ПеречислениеСсылка.СтатусыОтраженияДокументовВРеглУчете - текущий статус отражения документа;
//			* Отражен - Булево - признак отражения документа, истина если Статус = ОтраженоВРеглУчете ИЛИ Статус = ОтраженоВУчетеВручную;
//			* РучноеОтражение - Булево - признак ручного отражения документа, истина если Статус = ОтраженоВУчетеВручную ИЛИ Статус = КОтражениюВУчетеВручную;
//			* Комментарий - Строка - дополнительная информация по отражению документа. Заполняется пользователем если отражение ручное или содержит перечень ошибок, если не удалось отразить документ автоматически.
//
Функция ПолучитьДанныеОтраженияДокумента(Документ, Организация = Неопределено) Экспорт
	
	СтруктураВозврата = Новый Структура(
		"Статус, Отражен, РучноеОтражение, Комментарий", 
		Перечисления.СтатусыОтраженияДокументовВРеглУчете.ПустаяСсылка(), Ложь, Ложь);
	
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
		|	ОтражениеДокументовВРеглУчете.Статус,
		|	ВЫБОР
		|		КОГДА ОтражениеДокументовВРеглУчете.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыОтраженияДокументовВРеглУчете.НеУказаныСчетаУчета)
		|			ТОГДА 1
		|		КОГДА ОтражениеДокументовВРеглУчете.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыОтраженияДокументовВРеглУчете.КОтражениюВУчетеВручную)
		|			ТОГДА 2
		|		КОГДА ОтражениеДокументовВРеглУчете.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыОтраженияДокументовВРеглУчете.ОтраженоВУчетеВручную)
		|			ТОГДА 3
		|		КОГДА ОтражениеДокументовВРеглУчете.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыОтраженияДокументовВРеглУчете.КОтражениюВРеглУчете)
		|			ТОГДА 4
		|		КОГДА ОтражениеДокументовВРеглУчете.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыОтраженияДокументовВРеглУчете.ОтраженоВРеглУчете)
		|			ТОГДА 5
		|	КОНЕЦ КАК Приоритет,
		|	ОтражениеДокументовВРеглУчете.Комментарий,
		|	ВЫБОР
		|		КОГДА ОтражениеДокументовВРеглУчете.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыОтраженияДокументовВРеглУчете.ОтраженоВУчетеВручную)
		|				ИЛИ ОтражениеДокументовВРеглУчете.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыОтраженияДокументовВРеглУчете.ОтраженоВРеглУчете)
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК Отражен,
		|	ВЫБОР
		|		КОГДА ОтражениеДокументовВРеглУчете.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыОтраженияДокументовВРеглУчете.ОтраженоВУчетеВручную)
		|				ИЛИ ОтражениеДокументовВРеглУчете.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыОтраженияДокументовВРеглУчете.КОтражениюВУчетеВручную)
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК РучноеОтражение
		|ИЗ
		|	РегистрСведений.ОтражениеДокументовВРеглУчете КАК ОтражениеДокументовВРеглУчете
		|ГДЕ
		|	ОтражениеДокументовВРеглУчете.Регистратор = &Документ
		|	И (&ВсеОрганизации ИЛИ ОтражениеДокументовВРеглУчете.Организация В (&Организация))
		|
		|УПОРЯДОЧИТЬ ПО
		|	Приоритет";
		Запрос.УстановитьПараметр("Документ", Документ);
		Запрос.УстановитьПараметр("Организация", Организация);
		Запрос.УстановитьПараметр("ВсеОрганизации", НЕ ЗначениеЗаполнено(Организация));
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		ЗаполнитьЗначенияСвойств(СтруктураВозврата, Выборка);
	КонецЕсли;
	
	Возврат СтруктураВозврата;
	
КонецФункции

// Возвращает составной комментарий к неотраженному в регл. учете документу
//
// Параметры:
// 	Документ - ДокументСсылка - Документ, по которому необходимо получить комментарий
// 	Организация - СправочникСсылка.Организации, Массив Из СправочникСсылка.Организации - Дополнительный отбор, если необходимо получить комментарий отражения по конкретной организации
// Возвращаемое значение:
// 	 Строка - составной комментарий к неотраженному в учете документу.
//
Функция СводныйКомментарийПоДокументу(Документ, Организация = Неопределено) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Записи.Комментарий КАК Комментарий
	|ИЗ
	|	РегистрСведений.ОтражениеДокументовВРеглУчете КАК Записи
	|ГДЕ
	|	Записи.Регистратор = &Документ
	|	И (Записи.Организация В (&Организация) 
	|		ИЛИ &ВсеОрганизации)
	|";
	Запрос.УстановитьПараметр("Статус",         Перечисления.СтатусыОтраженияДокументовВРеглУчете.НеУказаныСчетаУчета);
	Запрос.УстановитьПараметр("Документ",       Документ);
	Запрос.УстановитьПараметр("Организация",    Организация);
	Запрос.УстановитьПараметр("ВсеОрганизации", НЕ ЗначениеЗаполнено(Организация));
	
	Выборка = Запрос.Выполнить().Выбрать();
	Подстроки = Новый Массив;
	Пока Выборка.Следующий() Цикл
		Если Выборка.Комментарий = "" Тогда
			Продолжить;
		КонецЕсли;
		Если Подстроки.Найти(Выборка.Комментарий) <> Неопределено Тогда
			Продолжить;
		КонецЕсли;
		Подстроки.Добавить(Выборка.Комментарий);
	КонецЦикла;
	
	Результат = СтрСоединить(Подстроки, Символы.ПС);
	
	Возврат Результат;
	
КонецФункции

// Устанавливает параметры выборочной регистрации документа к отражению в регл. учете.
// 
// Параметры:
// 	 ДопСвойства - Структура - Дополнительные свойства объекта
// 	 Организация - СправочникСсылка.Организации - Организация для выборочной регистрации к отражению
// 	 Период      - Дата - Дата выборочной регистрации к отражению в регл. учете.
//
Процедура ДобавитьПараметрыВыборочнойРегистрацииКОтражениюВРеглУчете(ДопСвойства, Организация, Период) Экспорт
	
	Если Не ДопСвойства.Свойство("ВыборочнаяРегистрацияКОтражениюВРеглУчете") Тогда
		
		ДопСвойства.Вставить("ВыборочнаяРегистрацияКОтражениюВРеглУчете", Истина);
		ТаблицаКРегистрацииВРеглУчете = Новый ТаблицаЗначений;
		ТаблицаКРегистрацииВРеглУчете.Колонки.Добавить("Организация",     Новый ОписаниеТипов("СправочникСсылка.Организации"));
		ТаблицаКРегистрацииВРеглУчете.Колонки.Добавить("ДатаОтражения",   Новый ОписаниеТипов("Дата"));
		ДопСвойства.Вставить("ТаблицаВыборочнойРегистрацииКОтражениюВРеглУчете", ТаблицаКРегистрацииВРеглУчете);
		
	КонецЕсли;
	
	Отбор = Новый Структура;
	Отбор.Вставить("Организация",   Организация);
	Отбор.Вставить("ДатаОтражения", НачалоДня(Период));
	
	РезультатПоиска = ДопСвойства.ТаблицаВыборочнойРегистрацииКОтражениюВРеглУчете.НайтиСтроки(Отбор);
	
	Если РезультатПоиска.Количество() = 0 Тогда
		НоваяСтрока = ДопСвойства.ТаблицаВыборочнойРегистрацииКОтражениюВРеглУчете.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, Отбор);
	КонецЕсли;
	
КонецПроцедуры

// Отключает регистрацию документа к отражению в регл. учете 
// 
// Параметры:
// 	 ДопСвойства - Структура - Дополнительные свойства объекта.
//
Процедура НеРегистрироватьКОтражениюВРеглУчете(ДопСвойства) Экспорт
	
	ДопСвойства.Вставить("НеРегистрироватьКОтражениюВРеглУчете", Истина);
	
КонецПроцедуры

// Определяет, должен ли документ отражаться в регл. учете или нет (по дате и дополнительным условиям:
//	некоторые документы ввод остатков, операция бух. - не зависят от даты начала ведения регл. учета).
//
//	Параметры:
//		Документ - ДокументСсылка - документ, для которого определяется возможность отражения в регл. учете;
//		ДатаДокумента - Дата - дата отражения документа, сравнивается с датой начала ведения регл. учета;
//		ДокументОснование - ДокументСсылка - если документ основания принадлежит к списку документов исключений, то и
//			текущий документ будет подпадать под исключение;
//
//	Возвращаемое значение:
//		Булево - отражается / не отражается в учете.
//
Функция ДокументОтражаетсяВРеглУчете(Документ, ДатаДокумента = Неопределено, ДокументОснование = Неопределено) Экспорт
	
	Если Не ПолучитьФункциональнуюОпцию("ИспользоватьРеглУчет") Тогда
		Возврат Ложь;
	КонецЕсли;
		
	МассивИсключений = ИменаДокументовОтражаемыеВРеглУчетеВнеЗависимостиОтДаты();
	
	Для каждого ИмяДокументаИсключения Из МассивИсключений Цикл
		Если ТипЗнч(Документ) = Тип("ДокументСсылка."+ИмяДокументаИсключения) Тогда
			Возврат Истина;
		КонецЕсли;
	КонецЦикла;
	
	ДокументыЗависимыеОтОснования = ИменаДокументовОтражаемыеВРеглУчетеВнеЗависимостиОтДатыЗависящиеОтОснования();
	
	РеквизитыДокумента = Новый Структура("Дата, Основание");
	РеквизитыДляПолучения = Новый Структура;
	Если ДатаДокумента <> Неопределено Тогда
		РеквизитыДокумента.Вставить("Дата", ДатаДокумента);
	Иначе
		РеквизитыДляПолучения.Вставить("Дата");
	КонецЕсли;
	
	МетаданныеДокумента = Документ.Метаданные();
	Если ДокументыЗависимыеОтОснования.Найти(МетаданныеДокумента.Имя) <> Неопределено Тогда
		Если ДокументОснование <> Неопределено Тогда
			РеквизитыДокумента.Вставить("Основание", ДокументОснование);
		ИначеЕсли МетаданныеДокумента.Реквизиты.Найти("ДокументОснование") <> Неопределено Тогда
			РеквизитыДляПолучения.Вставить("Основание", "ДокументОснование");
		ИначеЕсли МетаданныеДокумента.Реквизиты.Найти("Основание") <> Неопределено Тогда
			РеквизитыДляПолучения.Вставить("Основание", "Основание");
		КонецЕсли;
	КонецЕсли;
	Если РеквизитыДляПолучения.Количество() Тогда
		ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Документ, РеквизитыДляПолучения);
		ЗаполнитьЗначенияСвойств(РеквизитыДокумента, ЗначенияРеквизитов);
	КонецЕсли;
	
	Если ДокументыЗависимыеОтОснования.Найти(МетаданныеДокумента.Имя) <> Неопределено Тогда
		Для каждого ИмяДокументаИсключения Из МассивИсключений Цикл
			Если ТипЗнч(РеквизитыДокумента.Основание) = Тип("ДокументСсылка."+ИмяДокументаИсключения) Тогда
				Возврат Истина;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	Возврат ?(РеквизитыДокумента.Дата < Константы.ДатаНачалаВеденияРеглУчета.Получить(), Ложь, Истина);
	
КонецФункции

// Дополняет текст запроса дополнительными условиями по типу документов, которые могут отражаться в регл. учете
//	вне зависимости от даты начала отражения в регл. учете, учитываются так же и документы основания.
//
//	Параметры:
//		ТекстЗапроса - Строка - текст запроса, который будет обрабатываться, необходимо, чтобы в нем присутствовало условие на дату начала ведения регл. учета;
//		ИмяПоляДокумента - Строка - строка вида "Данные.Документ", где данные - таблица, для которой накладываются условия, документ - имя поля документа.
//
Процедура ДобавитьВЗапросФильтрОтраженияВРеглУчете(ТекстЗапроса, ИмяПоляДокумента) Экспорт
	
	// Добавим в запрос соединение с документами, зависящие от документа основания:
	
	ДокументыЗависимыеОтОснования = ИменаДокументовОтражаемыеВРеглУчетеВнеЗависимостиОтДатыЗависящиеОтОснования();
	
	ТекстДопСоединений = "";
	ПодстрокаЗаменыДопСоединений = 
	"ВНУТРЕННЕЕ СОЕДИНЕНИЕ Константы КАК Константы";
	Шаблон = 
	"ЛЕВОЕ СОЕДИНЕНИЕ Документ.%ВидДокументаЗависимогоОтОснования% КАК %ВидДокументаЗависимогоОтОснования%
	|		ПО %ВидДокументаЗависимогоОтОснования%.Ссылка = %ИмяПоляДокумента%
	|		";
	
	Для каждого ДокументЗависимыйОтОснования Из ДокументыЗависимыеОтОснования Цикл
		ТекущийШаблон = СтрЗаменить(Шаблон, "%ВидДокументаЗависимогоОтОснования%", ДокументЗависимыйОтОснования);
		ТекстДопСоединений = ТекстДопСоединений + ТекущийШаблон;
	КонецЦикла;
	
	// Добавим в запрос фильтр по документам исключений:
	
	ПодстрокаЗаменыДопУсловий = "Константы.ДатаНачалаВеденияРеглУчета";
	
	ТекстДопУсловий = "";
	МассивИсключений = ИменаДокументовОтражаемыеВРеглУчетеВнеЗависимостиОтДаты();
	
	ШаблонДопУсловийДляДокументаИсключений = "
		|		ИЛИ ТИПЗНАЧЕНИЯ(%ИмяПоляДокумента%) = ТИП(Документ.%ВидДокумента%)";
	ШаблонДопУсловийДляДокументаЗависимогоОтОснования = "
		|		ИЛИ (НЕ %ВидДокументаЗависимогоОтОснования%.Ссылка ЕСТЬ NULL И %ВидДокументаЗависимогоОтОснования%.ДокументОснование ССЫЛКА Документ.%ВидДокумента%)";
	
	Для каждого ИмяДокументаИсключения Из МассивИсключений Цикл
		ТекущийШаблон = СтрЗаменить(ШаблонДопУсловийДляДокументаИсключений, "%ВидДокумента%", ИмяДокументаИсключения);
		ТекстДопУсловий = ТекстДопУсловий + ТекущийШаблон;
		Для каждого ДокументЗависимыйОтОснования Из ДокументыЗависимыеОтОснования Цикл
			МетаданныеОснования = Метаданные.НайтиПоПолномуИмени("Документ."+ДокументЗависимыйОтОснования).Реквизиты.Найти("ДокументОснование");
			Если МетаданныеОснования <> Неопределено И МетаданныеОснования.Тип.СодержитТип(Тип("ДокументСсылка."+ИмяДокументаИсключения)) Тогда
				ТекущийШаблон = ШаблонДопУсловийДляДокументаЗависимогоОтОснования;
				ТекущийШаблон = СтрЗаменить(ТекущийШаблон, "%ВидДокумента%", ИмяДокументаИсключения);
				ТекущийШаблон = СтрЗаменить(ТекущийШаблон, "%ВидДокументаЗависимогоОтОснования%", ДокументЗависимыйОтОснования);
				ТекстДопУсловий = ТекстДопУсловий + ТекущийШаблон;
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, ПодстрокаЗаменыДопСоединений, ТекстДопСоединений + ПодстрокаЗаменыДопСоединений);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, ПодстрокаЗаменыДопУсловий, ПодстрокаЗаменыДопУсловий + ТекстДопУсловий);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%ИмяПоляДокумента%", ИмяПоляДокумента);
	
КонецПроцедуры

#Область НазначениеПараметровОтраженияРеглУчета

// Дополняет параметры запроса отражения документов в регл. учете значениями, необходимыми для документов
// последовательного отражения:
//		Ссылка - ДокументСсылка - ссылка на отражаемый документ;
//		Дата - Дата - период отражения документа;
//		ГраницаМесяцНачало - Граница - начало месяца отражения документа;
//		ГраницаМесяцОкончание - Граница - конец месяца отражения документа;
//		ВидыСубконтоХозрасчетныеОсновныеСредстваКонтрагенты - Массив, состоящий из значений типа "ПланыВидовХарактеристик.ВидыСубконтоХозрасчетные";
//
//	Параметры:
//		ПараметрыЗапроса - Структура - структура параметров для заполнения (см. РеглУчетВыборкиСерверПовтИсп.ПараметрыОтраженияРеглУчетаПоУмолчанию);
//		Ссылка - ДокументСсылка - ссылка на отражаемый документ;
//		Период - Дата - период отражения документа;
//
Процедура ДополнитьПараметрыОтраженияРеглУчетаДляДокументовПоследовательногоОтражения(ПараметрыЗапроса, Ссылка, Период) Экспорт
	
	ПараметрыЗапроса.Вставить("Ссылка", Ссылка);
	ПараметрыЗапроса.Вставить("Дата",   Период);
	
	ГраницаМесяцНачало = Новый Граница(НачалоМесяца(Период), ВидГраницы.Включая);
	ГраницаМесяцОкончание = Новый Граница(КонецМесяца(Период), ВидГраницы.Включая);
	ПараметрыЗапроса.Вставить("ГраницаМесяцНачало",    ГраницаМесяцНачало);
	ПараметрыЗапроса.Вставить("ГраницаМесяцОкончание", ГраницаМесяцОкончание);
	
	МассивВидовСубконто = Новый Массив;
	МассивВидовСубконто.Добавить(ПланыВидовХарактеристик.ВидыСубконтоХозрасчетные.ОсновныеСредства);
	МассивВидовСубконто.Добавить(ПланыВидовХарактеристик.ВидыСубконтоХозрасчетные.Контрагенты);
	ПараметрыЗапроса.Вставить("ВидыСубконтоХозрасчетныеОсновныеСредстваКонтрагенты", МассивВидовСубконто);
		
КонецПроцедуры

//	На основании переданных значений параметров заполняет параметры запроса данных.
//
//	Параметры:
//		ЗапросДанных - Запрос - запрос, параметры которого будут заполнены;
//		ЗначенияПараметровДляЗаполнения - Структура - содержит значения по умолчанию ((см. РеглУчетВыборкиСерверПовтИсп.ПараметрыОтраженияРеглУчетаПоУмолчанию);
//		ПараметрыЗапроса - коллекция параметров запроса - список параметров, которые будут заполнены, если не определен - будет заполнен на основании параметров запроса.
//
Процедура ЗаполнениеПараметровЗапросаИПрочихФункциональныхОпций(ЗапросДанных, ЗначенияПараметровДляЗаполнения, ПараметрыЗапроса = Неопределено) Экспорт
	
	Если ПараметрыЗапроса = Неопределено Тогда
		ПараметрыЗапроса = ЗапросДанных.НайтиПараметры();
	КонецЕсли;
	
	Для Каждого ПараметрДанных Из ПараметрыЗапроса Цикл
		ЗначениеПараметра = Неопределено;
		Если Не ЗначенияПараметровДляЗаполнения.Свойство(ПараметрДанных.Имя, ЗначениеПараметра) Тогда
			ЗначениеПараметра = ПолучитьФункциональнуюОпцию(ПараметрДанных.Имя);
		КонецЕсли;
		ЗапросДанных.УстановитьПараметр(ПараметрДанных.Имя, ЗначениеПараметра);
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

// Регистрирует документы расчетов с партнерами к отражению в регламентированном учете.
//
// Параметры:
//	МассивДокументов - Массив - массив документов к регистрации в регламентированном учете.
//
Процедура ЗарегистрироватьДокументыРасчетовСПартнерамиКОтражениюВРеглУчете(Расчеты) Экспорт
	
	Если Расчеты.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Расчеты.Регистратор               КАК Регистратор,
	|	Расчеты.Период                    КАК Период,
	|	Расчеты.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам 
	|ПОМЕСТИТЬ Расчеты
	|ИЗ
	|	&Расчеты КАК Расчеты
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	АналитикаУчетаПоПартнерам
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Расчеты.Регистратор                        КАК Документ,
	|	КлючиАналитикаУчетаПоПартнерам.Организация КАК Организация,
	|	НАЧАЛОПЕРИОДА(Расчеты.Период, ДЕНЬ)        КАК ДатаОтражения
	|ПОМЕСТИТЬ ДокументыКОтражению
	|ИЗ
	|	Расчеты КАК Расчеты
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		РегистрСведений.АналитикаУчетаПоПартнерам КАК КлючиАналитикаУчетаПоПартнерам
	|	ПО
	|		Расчеты.АналитикаУчетаПоПартнерам = КлючиАналитикаУчетаПоПартнерам.КлючАналитики
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	КонтрагентКонтрагент.Регистратор                 КАК Документ,
	|	КонтрагентКонтрагент.Организация                 КАК Организация,
	|	НАЧАЛОПЕРИОДА(КонтрагентКонтрагент.Период, ДЕНЬ) КАК ДатаОтражения
	|ИЗ
	|	РегистрНакопления.ДвиженияКонтрагентКонтрагент КАК КонтрагентКонтрагент
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		Расчеты КАК Расчеты
	|	ПО
	|		Расчеты.Регистратор = КонтрагентКонтрагент.Регистратор
	|ГДЕ
	|	КонтрагентКонтрагент.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВзаимозачетЗадолженности)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ Расчеты
	|;
	|";
	Запрос.УстановитьПараметр("Расчеты", Расчеты);
	Запрос.УстановитьПараметр("ТипыДокументов", ВнеоборотныеАктивы.ИдентификаторыДокументовПоКоторымФормируютсяОтложенныеДвижения());
	Запрос.Выполнить();
	ВернутьДокументыКОтражению(МенеджерВременныхТаблиц);
	
КонецПроцедуры

// Регистрирует документы к отражению в регламентированном учете.
//
// Параметры:
//	МассивДокументов - Массив - массив документов к регистрации в регламентированном учете.
//
Процедура ЗарегистрироватьДокументыКОтражениюВРеглУчете(МассивДокументов) Экспорт
	
	Если МассивДокументов.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ОтражениеДокументовВРеглУчете.Регистратор КАК Документ,
	|	ОтражениеДокументовВРеглУчете.Организация КАК Организация,
	|	ОтражениеДокументовВРеглУчете.ДатаОтражения КАК ДатаОтражения
	|ПОМЕСТИТЬ ДокументыКОтражению
	|ИЗ
	|	РегистрСведений.ОтражениеДокументовВРеглУчете КАК ОтражениеДокументовВРеглУчете
	|ГДЕ
	|	ОтражениеДокументовВРеглУчете.Регистратор В(&МассивДокументов)";
	Запрос.УстановитьПараметр("МассивДокументов", МассивДокументов);
	
	Запрос.Выполнить();
	ВернутьДокументыКОтражению(МенеджерВременныхТаблиц);
	
КонецПроцедуры
	
#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Выполняет обработку установки даты начала ведения УУ на плане счетов Хозрасчетный:
// - возвращает документы к отражению в регл. учете начиная с даты начала ведения УУ
// - очищает ресурс СуммаУУ в движениях регистра Хозрасчетный ранее даты начала ведения УУ.
//
Процедура ОбработкаУстановкиДатыНачалаУУНаПланеСчетовХозрасчетный(Параметры, АдресХранилища) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	ДатаНачалаУУ = Константы.ДатаНачалаУУНаПланеСчетовХозрасчетный.Получить();
	
	Результат = Новый Структура;
	Результат.Вставить("ВозвращеноКОтражению", 0);
	Результат.Вставить("ОчищенаСуммаУУ", 0);
	
	НачатьТранзакцию();
	Попытка
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ОтражениеДокументовВРеглУчете.Регистратор
		|ИЗ
		|	РегистрСведений.ОтражениеДокументовВРеглУчете КАК ОтражениеДокументовВРеглУчете
		|ГДЕ
		|	ОтражениеДокументовВРеглУчете.ДатаОтражения >= &ДатаНачалаУУ
		|	И НЕ ОтражениеДокументовВРеглУчете.Статус В (
		|		ЗНАЧЕНИЕ(Перечисление.СтатусыОтраженияДокументовВРеглУчете.КОтражениюВРеглУчете),
		|		ЗНАЧЕНИЕ(Перечисление.СтатусыОтраженияДокументовВРеглУчете.КОтражениюВУчетеВручную))
		|;
		|
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Хозрасчетный.Регистратор
		|ИЗ
		|	РегистрБухгалтерии.Хозрасчетный КАК Хозрасчетный
		|ГДЕ
		|	Хозрасчетный.Период < &ДатаНачалаУУ
		|	И Хозрасчетный.СуммаУУ <> 0
		|	И НЕ ТИПЗНАЧЕНИЯ(Хозрасчетный.Регистратор) В (
		|			ТИП(Документ.ВводОстатков),
		|			ТИП(Документ.ОперацияБух))
		|";
		Запрос.УстановитьПараметр("ДатаНачалаУУ", ДатаНачалаУУ); 
		РезультатЗапроса = Запрос.ВыполнитьПакет();
		
		ОтражениеВРеглУчете = РезультатЗапроса[0];
		ВыборкаОтражениеВРеглУчете = ОтражениеВРеглУчете.Выбрать();
		КоличествоВозвращеноКОтражению = ВыборкаОтражениеВРеглУчете.Количество();
		
		Хозрасчетный = РезультатЗапроса[1];
		ВыборкаХозрасчетный = Хозрасчетный.Выбрать();
		КоличествоОчищенаСуммаУУ = ВыборкаХозрасчетный.Количество();

		Блокировка = Новый БлокировкаДанных;
		
		ЭлементБлокировки = Блокировка.Добавить("РегистрСведений.ОтражениеДокументовВРеглУчете.НаборЗаписей");
		ЭлементБлокировки.ИсточникДанных = ОтражениеВРеглУчете;
		ЭлементБлокировки.ИспользоватьИзИсточникаДанных("Регистратор", "Регистратор");
		
		ЭлементБлокировки = Блокировка.Добавить("РегистрБухгалтерии.Хозрасчетный.НаборЗаписей");
		ЭлементБлокировки.ИсточникДанных = Хозрасчетный;
		ЭлементБлокировки.ИспользоватьИзИсточникаДанных("Регистратор", "Регистратор");
		
		Блокировка.Заблокировать();
		
		// Вернем документы к отражению в регл. учете
		МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
		
		Запрос = Новый Запрос;
		Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
		Запрос.Текст =
		"ВЫБРАТЬ
		|	ОтражениеДокументовВРеглУчете.Регистратор КАК Документ,
		|	ОтражениеДокументовВРеглУчете.Организация КАК Организация,
		|	ОтражениеДокументовВРеглУчете.ДатаОтражения КАК ДатаОтражения
		|ПОМЕСТИТЬ ДокументыКОтражению
		|ИЗ
		|	РегистрСведений.ОтражениеДокументовВРеглУчете КАК ОтражениеДокументовВРеглУчете
		|ГДЕ
		|	ОтражениеДокументовВРеглУчете.ДатаОтражения >= &ДатаНачалаУУ
		|";
		Запрос.УстановитьПараметр("ДатаНачалаУУ", ДатаНачалаУУ); 
		Запрос.Выполнить();
		
		РеглУчетПроведениеСервер.ВернутьДокументыКОтражению(МенеджерВременныхТаблиц);
		Результат.ВозвращеноКОтражению = КоличествоВозвращеноКОтражению;
		
		// Очистим ресурс СуммаУУ
		Пока ВыборкаХозрасчетный.Следующий() Цикл
			
			НаборЗаписей = РегистрыБухгалтерии.Хозрасчетный.СоздатьНаборЗаписей();
			НаборЗаписей.Отбор.Регистратор.Установить(ВыборкаХозрасчетный.Регистратор);
			НаборЗаписей.Прочитать();
			
			Для каждого Запись Из НаборЗаписей Цикл
				Если Запись.СуммаУУ <> 0 Тогда
					Запись.СуммаУУ = 0;
				КонецЕсли;
			КонецЦикла;
			
			НаборЗаписей.ОбменДанными.Загрузка = Истина;
			НаборЗаписей.Записать();
			
		КонецЦикла;
		Результат.ОчищенаСуммаУУ = КоличествоОчищенаСуммаУУ;
		
		ЗафиксироватьТранзакцию();
		
	Исключение
		
		ОтменитьТранзакцию();
		ТекстСообщения = СтрШаблон(НСтр("ru = 'Не удалось вернуть документы к отражению по причине: %1'"),
					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
			
		ЗаписьЖурналаРегистрации(
				НСтр("ru = 'Установка даты начала УУ на плане счетов Хозрасчетный.'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()), 
				УровеньЖурналаРегистрации.Ошибка, , , ТекстСообщения);
				
		ВызватьИсключение ТекстСообщения;
		
	КонецПопытки;
	
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ВЫРАЗИТЬ(ДокументыКОтражению.Документ КАК Документ.СчетФактураВыданныйАванс).ДокументОснование КАК Документ, 
	|	ВЫРАЗИТЬ(ДокументыКОтражению.Документ КАК Документ.СчетФактураВыданныйАванс).Контрагент КАК Контрагент,
	|	ДокументыКОтражению.ДатаОтражения КАК Период 
	|ИЗ 
	|	ДокументыКОтражению КАК ДокументыКОтражению
	|ГДЕ ТИПЗНАЧЕНИЯ(ДокументыКОтражению.Документ) = ТИП(Документ.СчетФактураВыданныйАванс)";
	
	РезультатЗапроса = Запрос.Выполнить();
	Если Не РезультатЗапроса.Пустой() Тогда
		Документы.СчетФактураВыданныйАванс.СформироватьДвиженияПоКнигамПокупокПродаж(РезультатЗапроса.Выгрузить());
	КонецЕсли;
	
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ВЫРАЗИТЬ(ДокументыКОтражению.Документ КАК Документ.СчетФактураПолученныйАванс).ДокументОснование КАК Документ, 
	|	ВЫРАЗИТЬ(ДокументыКОтражению.Документ КАК Документ.СчетФактураПолученныйАванс).Контрагент КАК Контрагент,
	|	ДокументыКОтражению.ДатаОтражения КАК Период 
	|ИЗ 
	|	ДокументыКОтражению КАК ДокументыКОтражению
	|ГДЕ ТИПЗНАЧЕНИЯ(ДокументыКОтражению.Документ) = ТИП(Документ.СчетФактураПолученныйАванс)";
	
	РезультатЗапроса = Запрос.Выполнить();
	Если Не РезультатЗапроса.Пустой() Тогда
		Документы.СчетФактураПолученныйАванс.СформироватьДвиженияПоКнигеПродаж(РезультатЗапроса.Выгрузить());
	КонецЕсли;
		
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ВЫРАЗИТЬ(ДокументыКОтражению.Документ КАК Документ.СчетФактураНалоговыйАгент).ДокументОснование КАК Документ, 
	|	ВЫРАЗИТЬ(ДокументыКОтражению.Документ КАК Документ.СчетФактураНалоговыйАгент).Поставщик КАК Контрагент,
	|	ДокументыКОтражению.ДатаОтражения КАК Период 
	|ИЗ 
	|	ДокументыКОтражению КАК ДокументыКОтражению
	|ГДЕ ТИПЗНАЧЕНИЯ(ДокументыКОтражению.Документ) = ТИП(Документ.СчетФактураНалоговыйАгент)";
	
	РезультатЗапроса = Запрос.Выполнить();
	Если Не РезультатЗапроса.Пустой() Тогда
		Документы.СчетФактураНалоговыйАгент.СформироватьДвиженияНДС(РезультатЗапроса.Выгрузить());
	КонецЕсли;
		
	ПоместитьВоВременноеХранилище(Результат, АдресХранилища);
	
КонецПроцедуры

// Восстановление партий, расчетов по документам, сумм в валюте регл., расчет себестоимости.
Процедура ВыполнитьОффлайновыеРасчеты(Документы)
	
	Если ТипЗнч(Документы) <> Тип("Массив") Тогда
		МассивСсылок = Новый Массив;
		МассивСсылок.Добавить(Документы);
	Иначе
		МассивСсылок = Документы;
	КонецЕсли;
	
	Если Не ПолучитьФункциональнуюОпцию("НоваяАрхитектураВзаиморасчетов") Тогда
		
		Запрос = Новый Запрос;
		Запрос.Текст =
		"ВЫБРАТЬ
		|	МАКСИМУМ(Данные.ДатаОтражения) КАК Период
		|ИЗ
		|	РегистрСведений.ОтражениеДокументовВРеглУчете КАК Данные
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Константы КАК Константы
		|		ПО (ИСТИНА)
		|ГДЕ
		|	Данные.Регистратор В (&МассивСсылок)
		|	И (Данные.ДатаОтражения >= Константы.ДатаНачалаВеденияРеглУчета)
		|ИМЕЮЩИЕ НЕ МАКСИМУМ(Данные.ДатаОтражения) ЕСТЬ NULL
		|;
		|
		|//////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Расчеты.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам
		|ИЗ
		|	РегистрНакопления.РасчетыСПоставщиками КАК Расчеты
		|ГДЕ
		|	Расчеты.Регистратор В (&МассивСсылок)
		|	И Расчеты.Активность
		|;
		|
		|//////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Расчеты.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам
		|ИЗ
		|	РегистрНакопления.РасчетыСКлиентами КАК Расчеты
		|ГДЕ
		|	Расчеты.Регистратор В (&МассивСсылок)
		|	И Расчеты.Активность";
		Запрос.УстановитьПараметр("МассивСсылок", МассивСсылок);
		Запрос.УстановитьПараметр("ТипыДокументов", ВнеоборотныеАктивы.ИдентификаторыДокументовПоКоторымФормируютсяОтложенныеДвижения());
		ДобавитьВЗапросФильтрОтраженияВРеглУчете(Запрос.Текст, "Данные.Регистратор");
		Результат = Запрос.ВыполнитьПакет();
		
		ВыборкаПериодРасчета = Результат[0].Выбрать();
		Если ВыборкаПериодРасчета.Следующий() Тогда
			ПериодРасчета = КонецМесяца(ВыборкаПериодРасчета.Период) + 1;
		Иначе
			// Переданные документы не требуют отражения, расчеты не выполняем
			Возврат;
		КонецЕсли;
		
		
		МассивАналитикПоставщиков = Результат[1].Выгрузить().ВыгрузитьКолонку("АналитикаУчетаПоПартнерам");
		Если МассивАналитикПоставщиков.Количество() > 0 Тогда
			АналитикиРасчета = РаспределениеВзаиморасчетовВызовСервера.АналитикиРасчета();
			АналитикиРасчета.АналитикиУчетаПоПартнерам = МассивАналитикПоставщиков;
			РаспределениеВзаиморасчетовВызовСервера.РаспределитьВсеРасчетыСПоставщиками(ПериодРасчета, АналитикиРасчета);
		КонецЕсли;
		
		МассивАналитикКлиентов = Результат[2].Выгрузить().ВыгрузитьКолонку("АналитикаУчетаПоПартнерам");
		Если МассивАналитикКлиентов.Количество() > 0 Тогда
			АналитикиРасчета = РаспределениеВзаиморасчетовВызовСервера.АналитикиРасчета();
			АналитикиРасчета.АналитикиУчетаПоПартнерам = МассивАналитикКлиентов;
			РаспределениеВзаиморасчетовВызовСервера.РаспределитьВсеРасчетыСКлиентами(ПериодРасчета, АналитикиРасчета);
		КонецЕсли;
		
	КонецЕсли;
	
	ОбновитьДанныеЗависимыхРегистров(МассивСсылок);
	
	ПериодРасчетаНДС = КонецМесяца(ТекущаяДатаСеанса());
	УчетНДСУП.ОтразитьДокументыВУчетеНДС(ПериодРасчетаНДС, МассивСсылок);
	
КонецПроцедуры

Процедура ОбновитьДанныеЗависимыхРегистров(МассивДокументов = Неопределено)
	
	Если МассивДокументов = Неопределено Тогда
		
		Запрос = Новый Запрос;
		Запрос.Текст =
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	ОтражениеДокументовВРеглУчете.Регистратор КАК Документ
		|ИЗ
		|	РегистрСведений.ОтражениеДокументовВРеглУчете КАК ОтражениеДокументовВРеглУчете
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Константы КАК Константы
		|		ПО (ИСТИНА)
		|ГДЕ
		|	ОтражениеДокументовВРеглУчете.Статус В (&СтатусыОтражения)
		|	И ОтражениеДокументовВРеглУчете.ДатаОтражения >= Константы.ДатаНачалаВеденияРеглУчета";
		ДобавитьВЗапросФильтрОтраженияВРеглУчете(Запрос.Текст, "ОтражениеДокументовВРеглУчете.Регистратор");
		СтатусыОтражения = Новый Массив;
		СтатусыОтражения.Добавить(Перечисления.СтатусыОтраженияДокументовВРеглУчете.КОтражениюВРеглУчете);
		СтатусыОтражения.Добавить(Перечисления.СтатусыОтраженияДокументовВРеглУчете.НеУказаныСчетаУчета);
		// Возможна ситуация когда ФО ручного отражения снята, но документы отраженные вручную есть - для них тоже надо делать отражение:
		Если Не ПолучитьФункциональнуюОпцию("ИспользоватьРучнуюКорректировкуПроводокПоРеглУчету") Тогда
			СтатусыОтражения.Добавить(Перечисления.СтатусыОтраженияДокументовВРеглУчете.КОтражениюВУчетеВручную);
			СтатусыОтражения.Добавить(Перечисления.СтатусыОтраженияДокументовВРеглУчете.ОтраженоВУчетеВручную);
		КонецЕсли;
		Запрос.УстановитьПараметр("СтатусыОтражения", СтатусыОтражения);
	
		РезультатЗапроса = Запрос.Выполнить();
		
		МассивДокументов = ?(РезультатЗапроса.Пустой(), Новый Массив, РезультатЗапроса.Выгрузить().ВыгрузитьКолонку("Документ"));
		
	КонецЕсли;
	
	Если МассивДокументов.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Если ПолучитьФункциональнуюОпцию("НоваяАрхитектураВзаиморасчетов") Тогда
		// В новых взаиморасчетах не выполняется регл. задание по пересчету взаиморасчетов, однако по прежнему необходимо обновлять данные
		// в регистре "СуммыДокументовВВалютеРегл" и других оборотных регистрах.
		РегистрыСведений.СуммыДокументовВВалютеРегл.РассчитатьСуммыДокументовВВалютеРегл(МассивДокументов);
		РегистрыСведений.СуммыДокументовВВалютеРегл.ОбновитьДвиженияПоОборотнымРегистрамНепересчитываемыхДокументов(МассивДокументов);
	КонецЕсли;
	
	ВнеоборотныеАктивы.ОтложенноеФормированиеДвиженийПриФормированииПроводок(МассивДокументов);
	ВнеоборотныеАктивы.РассчитатьСтоимостьВнеоборотныхАктивовПриФормированииПроводок(МассивДокументов);
	
КонецПроцедуры

Функция ОтразитьДокументыПакетноСЗамеромВремени(ТипДокумента, ВременныеТаблицы, Организация, ПериодРасчета)
	
	КлючеваяОперация = СтрШаблон("ОтражениеВРеглУчете.%1", Метаданные.НайтиПоТипу(ТипДокумента).Имя);
	ОписаниеЗамера = ОценкаПроизводительности.НачатьЗамерДлительнойОперации(КлючеваяОперация);
	
	Результат = ОтразитьДокументыПакетно(ТипДокумента, ВременныеТаблицы, Организация, ПериодРасчета);
	
	КоличествоОбработано = 
		Результат.КоличествоОтраженоВУчете 
		+ Результат.КоличествоНеУказаныСчетаУчета 
		+ Результат.КоличествоОшибкиПриОтражении;
		
	ОценкаПроизводительности.ЗакончитьЗамерДлительнойОперации(ОписаниеЗамера, КоличествоОбработано);
	
	Возврат Результат;
	
КонецФункции

Функция ОтразитьДокументыПакетно(ТипДокумента, ВременныеТаблицы, Организация, ПериодРасчета)
	
	РезультатВозврата = Новый Структура;
	РезультатВозврата.Вставить("КоличествоОтраженоВУчете", 0);
	РезультатВозврата.Вставить("КоличествоНеУказаныСчетаУчета", 0);
	РезультатВозврата.Вставить("КоличествоОшибкиПриОтражении", 0);
	
	МассивНеОтраженоВУчете = Новый Массив;
	Пока СформироватьТаблицыОтбораДанных(ТипДокумента, ВременныеТаблицы, Организация, ПериодРасчета, , МассивНеОтраженоВУчете) Цикл
		РезультатОтражения = ВыполнитьОтражение(ТипДокумента, ВременныеТаблицы, Истина);
		
		РезультатВозврата.КоличествоОтраженоВУчете = 
			РезультатВозврата.КоличествоОтраженоВУчете 
			+ РезультатОтражения.ОтраженоВУчете.Количество(); 
			
		РезультатВозврата.КоличествоНеУказаныСчетаУчета = 
			РезультатВозврата.КоличествоНеУказаныСчетаУчета 
			+ РезультатОтражения.НеУказаныСчетаУчета.Количество(); 
			
		РезультатВозврата.КоличествоОшибкиПриОтражении = 
			РезультатВозврата.КоличествоОшибкиПриОтражении 
			+ РезультатОтражения.ОшибкиПриОтражении.Количество(); 
		
		ОбщегоНазначенияКлиентСервер.ДополнитьМассив(МассивНеОтраженоВУчете, РезультатОтражения.НеУказаныСчетаУчета);
		ОбщегоНазначенияКлиентСервер.ДополнитьМассив(МассивНеОтраженоВУчете, РезультатОтражения.ОшибкиПриОтражении);
		
	КонецЦикла;
	
	Возврат РезультатВозврата;
	
КонецФункции

Функция ОтразитьДокументыПоследовательноСЗамеромВремени(ВременныеТаблицы, Организация, ПериодРасчета)
	
	ОписаниеЗамера = ОценкаПроизводительности.НачатьЗамерДлительнойОперации("ОтражениеВРеглУчете.ДокументыСПоследовательнымОтражением");
	
	Результат = ОтразитьДокументыПоследовательно(ВременныеТаблицы, Организация, ПериодРасчета);
	
	КоличествоОбработано = 
		Результат.КоличествоОтраженоВУчете 
		+ Результат.КоличествоНеУказаныСчетаУчета 
		+ Результат.КоличествоОшибкиПриОтражении;
		
	ОценкаПроизводительности.ЗакончитьЗамерДлительнойОперации(ОписаниеЗамера, КоличествоОбработано);
	
	Возврат Результат;
	
КонецФункции

Функция ОтразитьДокументыПоследовательно(ВременныеТаблицы, Организация, ПериодРасчета)
	
	РезультатВозврата = Новый Структура;
	РезультатВозврата.Вставить("КоличествоОтраженоВУчете", 0);
	РезультатВозврата.Вставить("КоличествоНеУказаныСчетаУчета", 0);
	РезультатВозврата.Вставить("КоличествоОшибкиПриОтражении", 0);
	
	Выборка = ДокументыКПоследовательномуОтражению(ПериодРасчета, Организация);
	Если Не Выборка = Неопределено Тогда
		Пока Выборка.Следующий() Цикл
			ТипДокумента = ТипЗнч(Выборка.Ссылка);
			Если СформироватьТаблицыОтбораДанных(ТипДокумента, ВременныеТаблицы, Организация, ПериодРасчета, Выборка.Ссылка) Тогда 
				
				РезультатОтражения = ВыполнитьОтражение(ТипДокумента, ВременныеТаблицы, Истина);
				
				РезультатВозврата.КоличествоОтраженоВУчете =                                               	
					РезультатВозврата.КоличествоОтраженоВУчете 
					+ РезультатОтражения.ОтраженоВУчете.Количество(); 
					
				РезультатВозврата.КоличествоНеУказаныСчетаУчета = 
					РезультатВозврата.КоличествоНеУказаныСчетаУчета 
					+ РезультатОтражения.НеУказаныСчетаУчета.Количество(); 
					
				РезультатВозврата.КоличествоОшибкиПриОтражении = 
					РезультатВозврата.КоличествоОшибкиПриОтражении 
					+ РезультатОтражения.ОшибкиПриОтражении.Количество(); 
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	Возврат РезультатВозврата;
	
КонецФункции

Функция ВыполнитьОтражение(ТипДокумента, ВременныеТаблицы, ПакетноеОтражение = Ложь)
	
	УстановитьПривилегированныйРежим(Истина);
	
	МетаданныеДокумента = Метаданные.НайтиПоТипу(ТипДокумента);
	ИмяДокумента = МетаданныеДокумента.Имя;
	
	Результат = ВыборкиОтраженияДокументов(ИмяДокумента, ВременныеТаблицы);
	
	ВыборкаСтатусов = Результат.ВыборкаСтатусов;
	
	
	ВыборкаПроверки = Результат.ВыборкаПроверки;
	ВыборкаПроверки.Следующий();
	
	ВыборкаХозрасчетный = Результат.ВыборкаХозрасчетный;
	ВыборкаХозрасчетный.Следующий();
	
	ВыборкаХозрасчетныйДополнение = Результат.ВыборкаХозрасчетныйДополнение;
	ВыборкаХозрасчетныйДополнение.Следующий();
	
	ВыборкаСвязанныеОперацииБух = Результат.ВыборкаСвязанныеОперацииБух;
	ВыборкаСвязанныеОперацииБух.Следующий();
	
	ОтраженоВУчете       = Новый Массив();
	НеУказаныСчетаУчета  = Новый Массив();
	ОшибкиПриОтражении   = Новый Массив();
	
	СтатусОтраженоВРеглУчете = Перечисления.СтатусыОтраженияДокументовВРеглУчете.ОтраженоВРеглУчете; 
	СтатусНеУказаныСчетаУчета = Перечисления.СтатусыОтраженияДокументовВРеглУчете.НеУказаныСчетаУчета;
	
	КоличествоДокументов = ВыборкаСтатусов.Количество();
	
	Пока ВыборкаСтатусов.Следующий() Цикл
		
		НачатьТранзакцию();
		
		Попытка
			
			Блокировка = Новый БлокировкаДанных;
			ЭлементБлокировки = Блокировка.Добавить("РегистрСведений.ОтражениеДокументовВРеглУчете.НаборЗаписей");
			ЭлементБлокировки.УстановитьЗначение("Регистратор", ВыборкаСтатусов.Ссылка);
			ЭлементБлокировки = Блокировка.Добавить("РегистрБухгалтерии.Хозрасчетный.НаборЗаписей");
			ЭлементБлокировки.УстановитьЗначение("Регистратор", ВыборкаСтатусов.Ссылка);
			
			Блокировка.Заблокировать();
			
			Если ДанныеДокументаИзменились(ВыборкаСтатусов) Тогда
				ОтменитьТранзакцию();
				СдвинутьВыборки(Результат);
				Продолжить;
			КонецЕсли;
			
			ОшибкиОтражения = ОшибкиОтраженияСЗаписьюВРегистрТребующихсяНастроек(ВыборкаСтатусов.Ссылка, ВыборкаПроверки);
			
			СформироватьОтражениеДокументовВРеглУчете(ВыборкаСтатусов, ОшибкиОтражения);
			СформироватьХозрасчетный(ВыборкаСтатусов, ВыборкаХозрасчетный, ВыборкаХозрасчетныйДополнение);
			
			ЗарегистрироватьКОтражениюСвязанныеОперацииБух(ВыборкаСтатусов, ВыборкаСвязанныеОперацииБух);
			
			Если ОшибкиОтражения.Количество() > 0 Тогда
				НеУказаныСчетаУчета.Добавить(ВыборкаСтатусов.Ссылка);
			Иначе
				ОтраженоВУчете.Добавить(ВыборкаСтатусов.Ссылка);
			КонецЕсли;
			
			ЗафиксироватьТранзакцию();
			
		Исключение
			
			ОтменитьТранзакцию();
			
			ОшибкиПриОтражении.Добавить(ВыборкаСтатусов.Ссылка);
			СдвинутьВыборки(Результат);
			
			ТекстСообщения = СтрШаблон(
					НСтр("ru = 'Не удалось отразить в регл. учете документ ""%1"" по причине: %2'"),
					ВыборкаСтатусов.Ссылка,
					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
			
			ЗаписьЖурналаРегистрации(
				НСтр("ru = 'Отражение в регламентированном учете'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()), 
				УровеньЖурналаРегистрации.Ошибка, , , ТекстСообщения);
				
			Если Не ПакетноеОтражение Тогда
				// Если отражаем документы не пакетно, то необходимо вызывать исключение при ошибки, для дополнительного уведомления пользователя.
				ВызватьИсключение ТекстСообщения;
			КонецЕсли;
			
		КонецПопытки;
		
	КонецЦикла;
	
	ЗапросЗаданийКФормированиюФинансовогоРезультата = РеглУчетВыборкиСерверПовтИсп.ЗапросЗаданияКФормированиюФинРезультата();
	ЗапросЗаданийКФормированиюФинансовогоРезультата.МенеджерВременныхТаблиц = ВременныеТаблицы;
	Выборка = ЗапросЗаданийКФормированиюФинансовогоРезультата.Выполнить().Выбрать();
	РегистрыСведений.ЗаданияКЗакрытиюМесяца.СоздатьЗаписиРегистраПоДаннымВыборки(Выборка);
	
	ДополнительнаяОбработкаПриОтраженииДокумента(ТипДокумента, ВременныеТаблицы);
	
	ЗапросОчистки = РеглУчетВыборкиСерверПовтИсп.ЗапросОчистки(ИмяДокумента);
	ЗапросОчистки.МенеджерВременныхТаблиц = ВременныеТаблицы;
	ЗапросОчистки.Выполнить();
	
	УстановитьПривилегированныйРежим(Ложь);
	
	Результат = Новый Структура();
	Результат.Вставить("ОтраженоВУчете",      ОтраженоВУчете);
	Результат.Вставить("НеУказаныСчетаУчета", НеУказаныСчетаУчета);
	Результат.Вставить("ОшибкиПриОтражении",  ОшибкиПриОтражении);
	
	Возврат Результат;
	
КонецФункции

Функция ВыборкиОтраженияДокументов(ИмяДокумента, ВременныеТаблицы)
	
	// Выборка статусов отражения документов из регистра ОтражениеДокументовВРеглУчете
	ЗапросОтражениеДокументовВРеглУчете = РеглУчетВыборкиСерверПовтИсп.ЗапросОтражениеДокументовВРеглУчете();
	ЗапросОтражениеДокументовВРеглУчете.МенеджерВременныхТаблиц = ВременныеТаблицы;
	
	РезультатОтражениеДокументовВРеглУчете = ЗапросОтражениеДокументовВРеглУчете.Выполнить();
	ВыборкаСтатусов = РезультатОтражениеДокументовВРеглУчете.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	КоличествоДокументов = ВыборкаСтатусов.Количество();
	
	
	// Выборка контекстных данных (данных из документов)
	ЭтоОбъектРасчетов = РеглУчетВыборкиСерверПовтИсп.ЭтоОбъектРасчетов(ИмяДокумента);
	ЗапросДанных = РеглУчетВыборкиСерверПовтИсп.ЗапросДанных(ИмяДокумента, ЭтоОбъектРасчетов);
	ЗапросДанных.МенеджерВременныхТаблиц = ВременныеТаблицы;
	УстановитьПараметрыЗапросаДанных(ЗапросДанных, Тип("ДокументСсылка." + ИмяДокумента), ИмяДокумента, ВыборкаСтатусов);
	
	ЗапросДанных.Выполнить();
	
	// Выборка счетов учета прочих операций
	ЗапросПрочихСчетов = РеглУчетВыборкиСерверПовтИсп.ЗапросПрочихСчетов();
	ЗапросПрочихСчетов.МенеджерВременныхТаблиц = ВременныеТаблицы;
	ЗапросПрочихСчетов.Выполнить();
	
	// Выборка создаваемых движений
	ЗапросСопоставлений = РеглУчетВыборкиСерверПовтИсп.ЗапросСопоставлений();
	ЗапросСопоставлений.МенеджерВременныхТаблиц = ВременныеТаблицы;
	ЗапросСопоставлений.Выполнить();
	
	// Проверяем полученные и дополненные данные
	ЗапросПроверки = РеглУчетВыборкиСерверПовтИсп.ЗапросПроверки();
	ЗапросПроверки.МенеджерВременныхТаблиц = ВременныеТаблицы;
	РезультатПроверки = ЗапросПроверки.Выполнить();
	ВыборкаПроверки = РезультатПроверки.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	ЗапросХозрасчетный = РеглУчетВыборкиСерверПовтИсп.ЗапросХозрасчетный();
	ЗапросХозрасчетный.МенеджерВременныхТаблиц = ВременныеТаблицы;
	РезультатХозрасчетный = ЗапросХозрасчетный.Выполнить();
	ВыборкаХозрасчетный = РезультатХозрасчетный.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	ЗапросХозрасчетныйДополнение = РеглУчетВыборкиСерверПовтИсп.ЗапросХозрасчетныйДополнение();
	ЗапросХозрасчетныйДополнение.МенеджерВременныхТаблиц = ВременныеТаблицы;
	ЗапросХозрасчетныйДополнение.УстановитьПараметр("ДокументыОтражаемыеПоследовательно", РеглУчетВыборкиСерверПовтИсп.ТипыДокументовКПоследовательномуОтражению());
	РезультатХозрасчетныйДополнение = ЗапросХозрасчетныйДополнение.Выполнить();
	ВыборкаЗапросХозрасчетныйДополнение = РезультатХозрасчетныйДополнение.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	// Выборка связанных документов ОперацияБух
	ЗапросСвязанныеОперацииБух = РеглУчетВыборкиСерверПовтИсп.ЗапросСвязанныеОперацииБух();
	ЗапросСвязанныеОперацииБух.МенеджерВременныхТаблиц = ВременныеТаблицы;
	РезультатСвязанныеОперацииБух = ЗапросСвязанныеОперацииБух.Выполнить();
	ВыборкаСвязанныеОперацииБух = РезультатСвязанныеОперацииБух.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	СтруктураВозврата = Новый Структура;
	СтруктураВозврата.Вставить("ВыборкаСтатусов",               ВыборкаСтатусов);
	СтруктураВозврата.Вставить("ВыборкаПроверки",               ВыборкаПроверки);
	СтруктураВозврата.Вставить("ВыборкаХозрасчетный",           ВыборкаХозрасчетный);
	СтруктураВозврата.Вставить("ВыборкаХозрасчетныйДополнение", ВыборкаЗапросХозрасчетныйДополнение);
	СтруктураВозврата.Вставить("ВыборкаСвязанныеОперацииБух",   ВыборкаСвязанныеОперацииБух);
	
	Возврат СтруктураВозврата;
	
КонецФункции

Функция КомментарийОшибокЗаполнения(РезультатПроверки)
	
	СтрокиКомментарий = Новый Массив();
	
	ВсегоОшибок = 0;
	ОШ = РезультатПроверки.Выбрать();
	Пока ОШ.Следующий() Цикл
		КомментарийОшибки = КомментарийОшибки(ОШ);
		Если ЗначениеЗаполнено(КомментарийОшибки) Тогда
			ВсегоОшибок = ВсегоОшибок + 1;
			СтрокиКомментарий.Добавить(КомментарийОшибки);
		КонецЕсли;
	КонецЦикла;
	
	Комментарий = СтрСоединить(СтрокиКомментарий, Символы.ПС);
	
	Возврат Комментарий;
	
КонецФункции

Функция ВременныеТаблицы(ВнешнийМенеджерВременныхТаблиц = Неопределено)
	
	ВременныеТаблицы = ВнешнийМенеджерВременныхТаблиц;
	
	Если ВременныеТаблицы = Неопределено Тогда
		
		ВременныеТаблицы = Новый МенеджерВременныхТаблиц;
		
		ТекстЗапроса = УчетНМА.ТекстЗапросаПустаяВременнаяТаблицаАмортизации()
						+ ОбщегоНазначенияБПВызовСервера.ТекстРазделителяЗапросовПакета()
						+ УчетНМА.ТекстЗапросаПустаяВременнаяТаблицаРасходыПоАренднымПлатежам()
						+ ОбщегоНазначенияБПВызовСервера.ТекстРазделителяЗапросовПакета()
						+ УчетНМА.ТекстЗапросаПустаяВременнаяТаблицаКорректировкаАмортизации();
						
		ЗапросПустыхТаблиц = Новый Запрос(ТекстЗапроса);
		ЗапросПустыхТаблиц.МенеджерВременныхТаблиц = ВременныеТаблицы;
		ЗапросПустыхТаблиц.Выполнить();
		
	КонецЕсли;
	
	ЗапросПланаСчетов = РеглУчетВыборкиСерверПовтИсп.ЗапросПланаСчетов();
	ЗапросПланаСчетов.МенеджерВременныхТаблиц = ВременныеТаблицы;
	ЗапросПланаСчетов.Выполнить();
	// выборка вариабельных счетов учета
	ЗапросСчетов = РеглУчетВыборкиСерверПовтИсп.ЗапросСчетов();
	ЗапросСчетов.МенеджерВременныхТаблиц = ВременныеТаблицы;
	ЗапросСчетов.Выполнить();
	
	// выборка счетов по умолчанию
	УстановитьПривилегированныйРежим(Истина);
	ЗапросСчетов = РеглУчетВыборкиСерверПовтИсп.ЗапросСчетовПоУмолчанию();
	ЗапросСчетов.МенеджерВременныхТаблиц = ВременныеТаблицы;
	ЗапросСчетов.Выполнить();
	
	Возврат ВременныеТаблицы;
КонецФункции

Процедура ДополнительнаяОбработкаПриОтраженииДокумента(ТипДокумента, МенеджерВременныхТаблиц)
	
	Если ТипДокумента = Тип("ДокументСсылка.ПринятиеКУчетуОС") Тогда
		Документы.ПринятиеКУчетуОС.ЗаполнитьПервоначальныеСуммыПриОтражении(МенеджерВременныхТаблиц);
	КонецЕсли;
	
	Если ТипДокумента = Тип("ДокументСсылка.ПринятиеКУчетуНМА") Тогда
		Документы.ПринятиеКУчетуНМА.ЗаполнитьПервоначальныеСуммыПриОтражении(МенеджерВременныхТаблиц);
	КонецЕсли;
	
	Если ТипДокумента = Тип("ДокументСсылка.МодернизацияОС") Тогда
		Документы.МодернизацияОС.ЗаполнитьПараметрыНачисленияАмортизацииПриОтражении(МенеджерВременныхТаблиц);
	КонецЕсли;
	
	Если ТипДокумента = Тип("ДокументСсылка.ВнутреннееПотреблениеТоваров") Тогда
		ВнутреннееПотреблениеТоваровЛокализация.ДополнительнаяОбработкаПриОтраженииДокумента(МенеджерВременныхТаблиц);
	КонецЕсли;
	
КонецПроцедуры

Процедура УстановитьПараметрыЗапросаДанных(ЗапросДанных, ТипДокумента, ИмяДокумента, ВыборкаДокументов)
	
	СтруктураПараметров = РеглУчетВыборкиСерверПовтИсп.ПараметрыОтраженияРеглУчетаПоУмолчанию();
	
	ТипыДокументов = РеглУчетВыборкиСерверПовтИсп.ТипыДокументовКПоследовательномуОтражению();
	Если ТипыДокументов.Найти(ТипДокумента) <> Неопределено 
		И ВыборкаДокументов.Количество() = 1 Тогда
		
		ВыборкаДокументов.Следующий();
		
		ДополнитьПараметрыОтраженияРеглУчетаДляДокументовПоследовательногоОтражения(СтруктураПараметров, ВыборкаДокументов.Ссылка, ВыборкаДокументов.Период);
		
		// Спозиционируем выборку в начало
		ВыборкаДокументов.Сбросить();
		
	КонецЕсли;
	
	// Устанавливаем параметры по-умолчанию и {&ИмяФункциональнойОпции}
	ЭтоОбъектРасчетов = РеглУчетВыборкиСерверПовтИсп.ЭтоОбъектРасчетов(ИмяДокумента); 
	ПараметрыДанных = РеглУчетВыборкиСерверПовтИсп.ЗапросДанныхПараметры(ИмяДокумента, ЭтоОбъектРасчетов);
	ЗаполнениеПараметровЗапросаИПрочихФункциональныхОпций(ЗапросДанных, СтруктураПараметров, ПараметрыДанных);
	
КонецПроцедуры

Функция ТипыДокументовКПакетномуОтражению(ПериодОтражения = Неопределено, Организация = Неопределено, МассивСсылок = Неопределено)
	
	Если Не ПолучитьФункциональнуюОпцию("ИспользоватьРеглУчет") Тогда
		Возврат Новый Массив;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ РАЗРЕШЕННЫЕ
	|	ТИПЗНАЧЕНИЯ(Данные.Регистратор) КАК ТипДокумента
	|ИЗ
	|	РегистрСведений.ОтражениеДокументовВРеглУчете КАК Данные
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Константы КАК Константы
	|		ПО (ИСТИНА)
	|ГДЕ
	|	(Данные.ДатаОтражения >= Константы.ДатаНачалаВеденияРеглУчета)
	|	И (&ВсеОрганизации 
	|		ИЛИ Данные.Организация = &Организация) 
	|	И (&ВесьПериод 
	|		ИЛИ Данные.ДатаОтражения <= &ПериодОтражения)
	|	И (&ВсеДокументы 
	|		ИЛИ Данные.Регистратор В (&МассивСсылок))
	|	И Данные.Статус В (
	|		ЗНАЧЕНИЕ(Перечисление.СтатусыОтраженияДокументовВРеглУчете.КОтражениюВРеглУчете),
	|		ЗНАЧЕНИЕ(Перечисление.СтатусыОтраженияДокументовВРеглУчете.НеУказаныСчетаУчета))
	|";
	
	Запрос.УстановитьПараметр("ПериодОтражения", ПериодОтражения);
	Запрос.УстановитьПараметр("ВесьПериод",      ?(ПериодОтражения = Неопределено, Истина, Ложь));
	Запрос.УстановитьПараметр("ВсеОрганизации",  НЕ ЗначениеЗаполнено(Организация));
	Запрос.УстановитьПараметр("Организация",     Организация);
	Запрос.УстановитьПараметр("МассивСсылок",    МассивСсылок);
	Запрос.УстановитьПараметр("ВсеДокументы",    ?(МассивСсылок = Неопределено, Истина, Ложь));
	
	ДобавитьВЗапросФильтрОтраженияВРеглУчете(Запрос.Текст, "Данные.Регистратор");
	ТипыДокументов = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("ТипДокумента");
	
	ИсключаемыеТипы = РеглУчетВыборкиСерверПовтИсп.ТипыДокументовКПоследовательномуОтражению();
	Результат = ОбщегоНазначенияКлиентСервер.РазностьМассивов(ТипыДокументов, ИсключаемыеТипы);
	
	Возврат Результат;
	
КонецФункции

Функция СформироватьТаблицыОтбораДанных(ТипДокумента, ВременныеТаблицы, Организация = Неопределено, ПериодОтражения = Неопределено, МассивСсылок = Неопределено, МассивИсключаемыхСсылок = Неопределено)
	
	Если МассивСсылок = Неопределено Тогда
		МассивСсылок = Новый Массив;
	КонецЕсли;
	
	Если МассивИсключаемыхСсылок = Неопределено Тогда
		МассивИсключаемыхСсылок = Новый Массив;
	КонецЕсли;
	
	ВозможноРучноеОтражениеДокумента = ПолучитьФункциональнуюОпцию("ИспользоватьРучнуюКорректировкуПроводокПоРеглУчету") И
		РеглУчетВыборкиСерверПовтИсп.ИсключенияИзРучнойКорректировкиПроводок().Найти(ТипДокумента) = Неопределено;
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = ВременныеТаблицы;
	
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ РАЗРЕШЕННЫЕ
	|	Данные.Период                       КАК Период,
	|	Данные.Регистратор                  КАК Ссылка,
	|	Данные.Организация                  КАК Организация,
	|	Данные.ДатаОтражения                КАК ДатаОтражения
	|ПОМЕСТИТЬ ДанныеРегистра
	|ИЗ
	|	РегистрСведений.ОтражениеДокументовВРеглУчете КАК Данные
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.СтатусыПроверкиДокументов КАК ДанныеПроверки
	|		ПО Данные.Регистратор = ДанныеПроверки.Документ
	|			И Данные.Организация = ДанныеПроверки.Организация
	|			И ТИПЗНАЧЕНИЯ(ДанныеПроверки.Документ) = &ТипДокумента
	|			И ДанныеПроверки.СтатусПроверки = ЗНАЧЕНИЕ(Перечисление.ЭтапыПроверкиДокументаВРеглУчете.Проверен)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Константы КАК Константы
	|		ПО (ИСТИНА)
	|ГДЕ
	|	Данные.Организация В (&Организация)
	|	И (Данные.ДатаОтражения >= Константы.ДатаНачалаВеденияРеглУчета)
	|	И Данные.ДатаОтражения <= &ПериодОтражения
	|	И Данные.Регистратор В (&МассивСсылок)
	|	И НЕ Данные.Регистратор В (&МассивИсключаемыхСсылок)
	|	И ТИПЗНАЧЕНИЯ(Данные.Регистратор) = &ТипДокумента
	|	И Данные.Статус В (&СтатусыОтражения)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка";
	
	Если ПериодОтражения = Неопределено Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "Данные.ДатаОтражения <= &ПериодОтражения", "ИСТИНА");
	Иначе
		Запрос.УстановитьПараметр("ПериодОтражения", ПериодОтражения);
	КонецЕсли;
	Если Не ЗначениеЗаполнено(Организация) Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "Данные.Организация В (&Организация)", "ИСТИНА");
	Иначе
		Запрос.УстановитьПараметр("Организация", Организация);
	КонецЕсли;
	Если Не ЗначениеЗаполнено(МассивСсылок) Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "Данные.Регистратор В (&МассивСсылок)", "ИСТИНА");
	Иначе
		Запрос.УстановитьПараметр("МассивСсылок", МассивСсылок);
	КонецЕсли;
	
	СтатусыОтражения = Новый Массив;
	СтатусыОтражения.Добавить(Перечисления.СтатусыОтраженияДокументовВРеглУчете.КОтражениюВРеглУчете);
	СтатусыОтражения.Добавить(Перечисления.СтатусыОтраженияДокументовВРеглУчете.НеУказаныСчетаУчета);
	// Возможна ситуация когда ФО ручного отражения снята, но документы отраженные вручную есть - для них тоже надо делать отражение:
	Если Не ВозможноРучноеОтражениеДокумента Тогда
		СтатусыОтражения.Добавить(Перечисления.СтатусыОтраженияДокументовВРеглУчете.КОтражениюВУчетеВручную);
		СтатусыОтражения.Добавить(Перечисления.СтатусыОтраженияДокументовВРеглУчете.ОтраженоВУчетеВручную);
	КонецЕсли;
	
	Запрос.УстановитьПараметр("СтатусыОтражения",        СтатусыОтражения);
	Запрос.УстановитьПараметр("ТипДокумента",            ТипДокумента);
	Запрос.УстановитьПараметр("МассивИсключаемыхСсылок", МассивИсключаемыхСсылок);
	
	// Будем отражать только проверенные документы только в том случае, если включены соотв. опции
	// и отражение происходит по всем документам (в противном случае не будут отражаться печатаемые документы):
	Если ЗначениеЗаполнено(МассивСсылок)
		ИЛИ НЕ ПолучитьФункциональнуюОпцию("ИспользоватьПроверкуДокументовПоРегламентированномуУчету")
		ИЛИ НЕ ПолучитьФункциональнуюОпцию("ОтражатьВРеглУчетеТолькоПроверенныеДокументы")
		ИЛИ НЕ ПроверкаДокументовСервер.ЭтотТипДокументаДолженПроверяться(ТипДокумента) Тогда
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.СтатусыПроверкиДокументов КАК ДанныеПроверки
	|		ПО Данные.Регистратор = ДанныеПроверки.Документ
	|			И Данные.Организация = ДанныеПроверки.Организация
	|			И ТИПЗНАЧЕНИЯ(ДанныеПроверки.Документ) = &ТипДокумента
	|			И ДанныеПроверки.СтатусПроверки = ЗНАЧЕНИЕ(Перечисление.ЭтапыПроверкиДокументаВРеглУчете.Проверен)
	|		", "");
	КонецЕсли;
	
	Запрос.Текст = Запрос.Текст + ОбщегоНазначенияУТ.РазделительЗапросовВПакете() +
	"ВЫБРАТЬ РАЗЛИЧНЫЕ ПЕРВЫЕ 1000 
	|	ДанныеРегистра.Ссылка КАК Ссылка,
	|	ДанныеРегистра.Период КАК Период
	|ПОМЕСТИТЬ ДокументыКОтражению
	|ИЗ
	|	ДанныеРегистра КАК ДанныеРегистра
	|	
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДанныеРегистра.Период         КАК Период,
	|	ДанныеРегистра.Ссылка         КАК Ссылка,
	|	ДанныеРегистра.Организация    КАК Организация,
	|	ДанныеРегистра.ДатаОтражения  КАК ДатаОтражения
	|ПОМЕСТИТЬ РазрезыКОтражению
	|ИЗ
	|	ДанныеРегистра КАК  ДанныеРегистра
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		ДокументыКОтражению КАК ДокументыКОтражению
	|	ПО
	|		ДанныеРегистра.Ссылка = ДокументыКОтражению.Ссылка
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка
	|;
	|
	|///////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДанныеРегистра
	|";
	
	ДобавитьВЗапросФильтрОтраженияВРеглУчете(Запрос.Текст, "Данные.Регистратор");
	РезультатЗапроса = Запрос.ВыполнитьПакет();
	Выборка = РезультатЗапроса[0].Выбрать();
	Если Выборка.Следующий() Тогда
		ЕстьДокументыКОтражению = Выборка.Количество <> 0;
	Иначе
		ЕстьДокументыКОтражению = Ложь;
	КонецЕсли;
	
	ПроверитьБлокировкуВходящихДанных(ТипДокумента, ВременныеТаблицы);
	
	Если НЕ ЕстьДокументыКОтражению Тогда
		// Уничтожим пустую таблицу документов к отражению
		ОбщегоНазначенияУТ.УничтожитьВременныеТаблицы(Запрос.МенеджерВременныхТаблиц, "РазрезыКОтражению,ДокументыКОтражению");
	КонецЕсли;
	
	Возврат ЕстьДокументыКОтражению;
	
КонецФункции

Функция ДокументыКПоследовательномуОтражению(ПериодОтражения, Организация = Неопределено, МассивСсылок = Неопределено)
	
	Если Не ПолучитьФункциональнуюОпцию("ИспользоватьРеглУчет") Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	Данные.Регистратор   КАК Ссылка,
	|	Данные.МоментВремени КАК МоментВремени
	|ИЗ
	|	РегистрСведений.ОтражениеДокументовВРеглУчете КАК Данные
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Константы КАК Константы
	|		ПО (ИСТИНА)
	|ГДЕ
	|	(Данные.ДатаОтражения >= Константы.ДатаНачалаВеденияРеглУчета)
	|	И (&ВсеОрганизации
	|		ИЛИ Данные.Организация = &Организация)
	|	И (&ВесьПериод 
	|		ИЛИ Данные.ДатаОтражения <= &ПериодОтражения)
	|	И (&ВсеДокументы 
	|		ИЛИ Данные.Регистратор В (&МассивСсылок))
	|	И ТИПЗНАЧЕНИЯ(Данные.Регистратор) В (&ТипыДокументов)
	|	И Данные.Статус В (
	|		ЗНАЧЕНИЕ(Перечисление.СтатусыОтраженияДокументовВРеглУчете.КОтражениюВРеглУчете),
	|		ЗНАЧЕНИЕ(Перечисление.СтатусыОтраженияДокументовВРеглУчете.НеУказаныСчетаУчета))
	|
	|УПОРЯДОЧИТЬ ПО
	|	Данные.МоментВремени
	|";
	
	Запрос.УстановитьПараметр("ПериодОтражения",   ПериодОтражения);
	Запрос.УстановитьПараметр("ВесьПериод",        ?(ПериодОтражения = Неопределено, Истина, Ложь));
	Запрос.УстановитьПараметр("ВсеОрганизации",    НЕ ЗначениеЗаполнено(Организация));
	Запрос.УстановитьПараметр("Организация",       Организация);
	Запрос.УстановитьПараметр("ТипыДокументов",    РеглУчетВыборкиСерверПовтИсп.ТипыДокументовКПоследовательномуОтражению());
	Запрос.УстановитьПараметр("МассивСсылок",      МассивСсылок);
	Запрос.УстановитьПараметр("ВсеДокументы",     ?(МассивСсылок = Неопределено, Истина, Ложь));
	
	ДобавитьВЗапросФильтрОтраженияВРеглУчете(Запрос.Текст, "Данные.Регистратор");
	Возврат Запрос.Выполнить().Выбрать();
	
КонецФункции

Функция НеотраженныеВРеглУчетеДокументы(МассивДокументов)
	
	УстановитьПривилегированныйРежим(Истина);
	
	НеотраженныеДокументы = Новый Массив;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ОтражениеДокументовВРеглУчете.Регистратор КАК Ссылка
	|ИЗ
	|	РегистрСведений.ОтражениеДокументовВРеглУчете КАК ОтражениеДокументовВРеглУчете
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Константы КАК Константы
	|		ПО (ИСТИНА)
	|ГДЕ
	|	ОтражениеДокументовВРеглУчете.Регистратор В (&МассивДокументов)
	|	И (ОтражениеДокументовВРеглУчете.ДатаОтражения >= Константы.ДатаНачалаВеденияРеглУчета)
	|	И НЕ ОтражениеДокументовВРеглУчете.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыОтраженияДокументовВРеглУчете.ОтраженоВРеглУчете)
	|	И НЕ ОтражениеДокументовВРеглУчете.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыОтраженияДокументовВРеглУчете.ОтраженоВУчетеВручную)
	|";
	
	Запрос.УстановитьПараметр("МассивДокументов", МассивДокументов);
	
	ДобавитьВЗапросФильтрОтраженияВРеглУчете(Запрос.Текст, "ОтражениеДокументовВРеглУчете.Регистратор");
	Результат = Запрос.Выполнить();
	Если Не Результат.Пустой() Тогда
		НеотраженныеДокументы = Результат.Выгрузить().ВыгрузитьКолонку("Ссылка");
	КонецЕсли;
	
	Возврат НеотраженныеДокументы;
	
КонецФункции

Функция ДанныеДокументаИзменились(ВыборкаСтатусов) 
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	Статусы.ИдентификаторСтатуса КАК ИдентификаторСтатуса
	|ИЗ
	|	РегистрСведений.ОтражениеДокументовВРеглУчете КАК Статусы
	|ГДЕ
	|	Статусы.Регистратор = &Ссылка
	|";
	Запрос.УстановитьПараметр("Ссылка", ВыборкаСтатусов.Ссылка);
	ВыборкаТекущихСтатусов = Запрос.Выполнить().Выбрать();
	
	Если ВыборкаТекущихСтатусов.Следующий() Тогда
		ДанныеИзменились = (ВыборкаТекущихСтатусов.ИдентификаторСтатуса <> ВыборкаСтатусов.ИдентификаторСтатуса);
	Иначе
		ДанныеИзменились = Истина;
	КонецЕсли;
	
	Возврат ДанныеИзменились;
	
КонецФункции

Процедура СдвинутьВыборки(Выборки)
	
	ТекущаяСсылка = Выборки.ВыборкаСтатусов.Ссылка;
	
	Если Выборки.ВыборкаПроверки.Ссылка = ТекущаяСсылка Тогда
		Выборки.ВыборкаПроверки.Следующий();
	КонецЕсли;
	Если Выборки.ВыборкаХозрасчетный.Ссылка = ТекущаяСсылка Тогда
		Выборки.ВыборкаХозрасчетный.Следующий();
	КонецЕсли;
	Если Выборки.ВыборкаХозрасчетныйДополнение.Ссылка = ТекущаяСсылка Тогда
		Выборки.ВыборкаХозрасчетныйДополнение.Следующий();
	КонецЕсли;
	Если Выборки.ВыборкаСвязанныеОперацииБух.Ссылка = ТекущаяСсылка Тогда
		Выборки.ВыборкаСвязанныеОперацииБух.Следующий();
	КонецЕсли;
	
КонецПроцедуры

#Область ФормированиеИЗаписьДвижений

Процедура СформироватьОтражениеДокументовВРеглУчете(ВыборкаСтатусов, ОшибкиОтражения)
	
	СтатусыОтраженияВРеглУчете = Перечисления.СтатусыОтраженияДокументовВРеглУчете;
	
	ОтражениеВРеглУчете = РегистрыСведений.ОтражениеДокументовВРеглУчете.СоздатьНаборЗаписей();
	ОтражениеВРеглУчете.Отбор.Регистратор.Установить(ВыборкаСтатусов.Ссылка);
	
	ВыборкаСтатусовПоОрганизациям = ВыборкаСтатусов.Выбрать();
	
	ШаблонЗапретаДанных = ДатыЗапретаИзменения.ШаблонДанныхДляПроверки();
	Пока ВыборкаСтатусовПоОрганизациям.Следующий() Цикл
		
		ОбновитьСтатус = (ВыборкаСтатусовПоОрганизациям.Статус = Неопределено);
		
		НоваяЗапись = ОтражениеВРеглУчете.Добавить();
		
		ЗаполнитьЗначенияСвойств(НоваяЗапись, ВыборкаСтатусовПоОрганизациям);
		
		Если ОбновитьСтатус Тогда
			Отбор = Новый Структура("Организация, ДатаОтражения", НоваяЗапись.Организация, НоваяЗапись.ДатаОтражения);
			Ошибки = ОшибкиОтражения.НайтиСтроки(Отбор);
			Если Ошибки.Количество() > 0 Тогда
				НоваяЗапись.Статус = СтатусыОтраженияВРеглУчете.НеУказаныСчетаУчета;
				НоваяЗапись.Комментарий = Ошибки[0].Комментарий;
			Иначе
				НоваяЗапись.Статус = СтатусыОтраженияВРеглУчете.ОтраженоВРеглУчете;
				НоваяЗапись.Комментарий = "";
			КонецЕсли;
			Если ТипЗнч(ВыборкаСтатусов.Ссылка) = Тип("ДокументСсылка.КорректировкаРеализации")
				И ВыборкаСтатусовПоОрганизациям.ДатаОтражения <> НачалоДня(ВыборкаСтатусовПоОрганизациям.Период) Тогда
				Продолжить;
			КонецЕсли;
			СтрокаШаблона = ШаблонЗапретаДанных.Добавить();
			СтрокаШаблона.Дата   = ВыборкаСтатусовПоОрганизациям.ДатаОтражения;
			СтрокаШаблона.Раздел = "БухгалтерскийУчет";
			СтрокаШаблона.Объект = ВыборкаСтатусовПоОрганизациям.Организация;
		КонецЕсли;
		
	КонецЦикла;
	
	ПроверитьДатуЗапретаДляОтраженияДокументовВРеглУчете(ШаблонЗапретаДанных, ОтражениеВРеглУчете, ВыборкаСтатусов.Ссылка);
	
	ОтражениеВРеглУчете.Записать();
	
КонецПроцедуры


Процедура СформироватьХозрасчетный(ВыборкаСтатусов, ВыборкаХозрасчетный, ВыборкаХозрасчетныйДополнение)
	
	НаборЗаписей = РегистрыБухгалтерии.Хозрасчетный.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.Регистратор.Установить(ВыборкаСтатусов.Ссылка);
	УстановитьДопСвойстваНабораЗаписейХозрасчетный(НаборЗаписей, ВыборкаСтатусов.Ссылка);
	
	ТаблицаПроводок = ТаблицаПроводок(НаборЗаписей);
	Если ВыборкаСтатусов.Ссылка = ВыборкаХозрасчетный.Ссылка Тогда
		ДобавитьСтрокиВТаблицуПроводок(ТаблицаПроводок, ВыборкаХозрасчетный);
		ВыборкаХозрасчетный.Следующий();
	КонецЕсли;
	
	// Выполним доп. обработку новых проводок.
	НаборЗаписей.Загрузить(ТаблицаПроводок);
	РегистрыБухгалтерии.Хозрасчетный.ВыполнитьДопОбработкуПроводок(
		НаборЗаписей);
		
	// Дополним набор проводками, которые необходимо оставить без изменения.
	ТаблицаПроводок = ТаблицаПроводок(НаборЗаписей);
	Если ВыборкаСтатусов.Ссылка = ВыборкаХозрасчетныйДополнение.Ссылка Тогда
		ДобавитьСтрокиВТаблицуПроводок(ТаблицаПроводок, ВыборкаХозрасчетныйДополнение);
		ВыборкаХозрасчетныйДополнение.Следующий();
	КонецЕсли;
	
	ТаблицаПроводок.Сортировать("Период");
	
	НаборЗаписей.Загрузить(ТаблицаПроводок);
	НаборЗаписей.Записать();
	
КонецПроцедуры

Функция ОшибкиОтраженияСЗаписьюВРегистрТребующихсяНастроек(Документ, ВыборкаПроверки)
	
	Результат = Новый ТаблицаЗначений;
	Результат.Колонки.Добавить("Организация");
	Результат.Колонки.Добавить("ДатаОтражения");
	Результат.Колонки.Добавить("Комментарий");
	
	Если Документ <> ВыборкаПроверки.Ссылка Тогда
		Возврат Результат;
	КонецЕсли;
	
	ВыборкаПоОрганизации = ВыборкаПроверки.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока ВыборкаПоОрганизации.Следующий() Цикл
		ВыборкаПоМесяцуОтражения = ВыборкаПоОрганизации.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		Пока ВыборкаПоМесяцуОтражения.Следующий() Цикл
			НоваяСтрока = Результат.Добавить();
			НоваяСтрока.Организация   = ВыборкаПоМесяцуОтражения.Организация;
			НоваяСтрока.ДатаОтражения = ВыборкаПоМесяцуОтражения.ДатаОтражения;
			ТаблицаОшибок			  = ТаблицаОшибокОтражения(ВыборкаПоМесяцуОтражения);
			НоваяСтрока.Комментарий   = СтрСоединить(ОбщегоНазначения.ВыгрузитьКолонку(ТаблицаОшибок, "Комментарий", Истина), Символы.ПС);
			ЗаписатьТребующиеНастройкиСчетаРеглУчета(ТаблицаОшибок, Документ);
		КонецЦикла;
	КонецЦикла;
	
	ВыборкаПроверки.Следующий();
	
	Возврат Результат;
	
КонецФункции

Функция ТаблицаПроводок(НаборЗаписей = Неопределено)
	
	Если НаборЗаписей = Неопределено Тогда
		НаборЗаписей = РегистрыБухгалтерии.Хозрасчетный.СоздатьНаборЗаписей();
	КонецЕсли;
	
	ТаблицаПроводок = НаборЗаписей.Выгрузить();
	ТаблицаПроводок.Колонки.Удалить("Активность");
	
	Возврат ТаблицаПроводок;
	
КонецФункции

Процедура ДобавитьСтрокиВТаблицуПроводок(ТаблицаПроводок, ВыборкаПоДокументу)
	
	Выборка = ВыборкаПоДокументу.Выбрать(); 
	
	Пока Выборка.Следующий() Цикл
		НоваяЗапись = ТаблицаПроводок.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяЗапись, Выборка);
	КонецЦикла;
	
КонецПроцедуры

Процедура УстановитьДопСвойстваНабораЗаписейХозрасчетный(НаборЗаписей, Ссылка)
	
	ТипСсылки = ТипЗнч(Ссылка);
	
	Если ТипСсылки = Тип("ДокументСсылка.КорректировкаРеализации")
		Или ТипСсылки = Тип("ДокументСсылка.ВозвратТоваровОтКлиента")
		Или ТипСсылки = Тип("ДокументСсылка.ВозвратТоваровМеждуОрганизациями")
		Или ТипСсылки = Тип("ДокументСсылка.РаспределениеПрочихЗатрат")
		Или ВнеоборотныеАктивыЛокализация.СуммыНалоговогоУчетаЗаполнены(ТипСсылки)
		Тогда
		
		НаборЗаписей.ДополнительныеСвойства.Вставить("СуммыНалоговогоУчетаЗаполнены", Истина);
	КонецЕсли;
	
	НаборЗаписей.ДополнительныеСвойства.Вставить("ПропуститьПроверкуЗапретаИзменения", Истина);
	НаборЗаписей.ДополнительныеСвойства.Вставить("НеВыполнятьДопОбработкуПроводок", Истина);
	
КонецПроцедуры

Процедура ЗарегистрироватьКОтражениюСвязанныеОперацииБух(ВыборкаСтатусов, ВыборкаСвязанныеОперацииБух)
	
	Если ВыборкаСтатусов.Ссылка <> ВыборкаСвязанныеОперацииБух.Ссылка Тогда
		Возврат;
	КонецЕсли;
	
	ВыборкаДокументы = ВыборкаСвязанныеОперацииБух.Выбрать();
	Пока ВыборкаДокументы.Следующий() Цикл
		
		Блокировка = Новый БлокировкаДанных;
		ЭлементБлокировки = Блокировка.Добавить("РегистрСведений.ОтражениеДокументовВРеглУчете.НаборЗаписей");
		ЭлементБлокировки.УстановитьЗначение("Регистратор", ВыборкаДокументы.Регистратор);
		Блокировка.Заблокировать();
			
		ОтражениеВРеглУчете = РегистрыСведений.ОтражениеДокументовВРеглУчете.СоздатьНаборЗаписей();
		ОтражениеВРеглУчете.Отбор.Регистратор.Установить(ВыборкаДокументы.Регистратор);
		
		НоваяЗапись = ОтражениеВРеглУчете.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяЗапись, ВыборкаДокументы);
		
		ОтражениеВРеглУчете.Записать();
		
	КонецЦикла;
	
	ВыборкаСвязанныеОперацииБух.Следующий();
	
КонецПроцедуры

Функция ТаблицаОшибокОтражения(РезультатПроверки)
	
	Результат = Новый ТаблицаЗначений;
	Результат.Колонки.Добавить("Организация");
	Результат.Колонки.Добавить("АналитикаУчета");
	Результат.Колонки.Добавить("МестоУчета");
	Результат.Колонки.Добавить("ВидСчета");
	Результат.Колонки.Добавить("Комментарий");
	
	ВыборкаОшибок = РезультатПроверки.Выбрать();
	Пока ВыборкаОшибок.Следующий() Цикл
		
		КомментарийОшибки = КомментарийОшибки(ВыборкаОшибок);
		Если ЗначениеЗаполнено(КомментарийОшибки) Тогда
			НоваяСтрокаОшибки = Результат.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрокаОшибки, ВыборкаОшибок);
			НоваяСтрокаОшибки.Комментарий = КомментарийОшибки;
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

Процедура ЗаписатьТребующиеНастройкиСчетаРеглУчета(ТаблицаОшибокОтражения, ОтражаемыйДокумент)
	
	НачатьТранзакцию();
	
	Попытка
		
		Для каждого СтрокаОшибки Из ТаблицаОшибокОтражения Цикл
			
			ИзмеренияРегистра = РегистрыСведений.СчетаРеглУчетаТребующиеНастройки.СписокИзмеренийРегистраПоВидуСчета(СтрокаОшибки.ВидСчета);
			ИзмеренияРегистра.Добавить("ВидСчета");
			
			Если ТипЗнч(СтрокаОшибки.ВидСчета) <> Тип("ПеречислениеСсылка.ВидыСчетовРеглУчета") Тогда
				ТекстСообщения = НСтр("ru = 'При записи счетов требующих настроек, ошибка: некорректно задан вид счета ""%1"".'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
				ТекстСообщения = СтрШаблон(ТекстСообщения, СтрокаОшибки.ВидСчета);
				ЗаписьЖурналаРегистрации(НСтр("ru = 'Отражение в регламентированном учете'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()), 
					УровеньЖурналаРегистрации.Ошибка, Метаданные.РегистрыСведений.СчетаРеглУчетаТребующиеНастройки, ОтражаемыйДокумент, ТекстСообщения);
				Продолжить;
			КонецЕсли;
			
			Если РегистрыСведений.СчетаРеглУчетаТребующиеНастройки.НастраиваемыеВидыСчетов().Найти(СтрокаОшибки.ВидСчета) = Неопределено Тогда
				// Ненастраиваемые счета учета не записываем в регистр.
				Продолжить;
			КонецЕсли;
			
			БлокировкаДанных = Новый БлокировкаДанных;
			ЭлементБлокировкиДанных = БлокировкаДанных.Добавить("РегистрСведений.СчетаРеглУчетаТребующиеНастройки");
			Для каждого ЭлементИзмерения Из ИзмеренияРегистра Цикл
				ЭлементБлокировкиДанных.УстановитьЗначение(ЭлементИзмерения, СтрокаОшибки[ЭлементИзмерения]);
			КонецЦикла;
			ЭлементБлокировкиДанных.Режим = РежимБлокировкиДанных.Исключительный;
			БлокировкаДанных.Заблокировать();
		
			НаборЗаписей = РегистрыСведений.СчетаРеглУчетаТребующиеНастройки.СоздатьНаборЗаписей();
			НаборЗаписей.ДополнительныеСвойства.Вставить("Документ", ОтражаемыйДокумент);
			Для каждого ЭлементИзмерения Из ИзмеренияРегистра Цикл
				НаборЗаписей.Отбор[ЭлементИзмерения].Установить(СтрокаОшибки[ЭлементИзмерения]);
			КонецЦикла;
			НоваяЗапись = НаборЗаписей.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяЗапись, СтрокаОшибки);
			НаборЗаписей.Записать();
			
		КонецЦикла;
		
		ЗафиксироватьТранзакцию();
		
	Исключение
		
		ОтменитьТранзакцию();
		ВызватьИсключение ОписаниеОшибки();
		
	КонецПопытки;
		
КонецПроцедуры

Функция КомментарийОшибки(СтрокаОшибки)
	
	КодОшибки = СтрокаОшибки.КодОшибки;
	Если КодОшибки = NULL Тогда
		// Строка итогов
		Возврат "";
	КонецЕсли;
	КомментарийОшибки = РеглУчетВыборкиСерверПовтИсп.ШаблонКомментарияОшибок(КодОшибки);
	КомментарийОшибки = СтрЗаменить(КомментарийОшибки, "%ВидСчета%", 
		РеглУчетВыборкиСерверПовтИсп.СтрокаВидСчета(СтрокаОшибки.ВидСчета, СтрокаОшибки.ДопИнформацияПоРасчетамСПартнерами));
	КомментарийОшибки = СтрЗаменить(КомментарийОшибки, "%Измерение%", 
		РеглУчетВыборкиСерверПовтИсп.СтрокаИзмерениеНастройки(СтрокаОшибки.ВидСчета, СтрокаОшибки.ИдентификаторСтроки, СтрокаОшибки.Организация));
	КомментарийОшибки = СтрЗаменить(КомментарийОшибки, "%МестоАналитика%", 
		РеглУчетВыборкиСерверПовтИсп.СтрокаМестоАналитика(СтрокаОшибки.МестоУчета, СтрокаОшибки.АналитикаУчета));
	КомментарийОшибки = СтрЗаменить(КомментарийОшибки, "%Счет%", Строка(СтрокаОшибки.Счет));
	
	Возврат КомментарийОшибки;
	
КонецФункции

#КонецОбласти

#Область ПроверкаБлокировкиДанных

Процедура ПроверитьБлокировкуВходящихДанных(ТипДокумента, Отбор = Неопределено, МассивСсылок = Неопределено)
	
	Если ПолучитьФункциональнуюОпцию("ОтложенноеОбновлениеЗавершеноУспешно") Тогда
		Возврат; // обновление ИБ завершено полностью
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Истина);
	
	ОбъектМетаданных = Метаданные.НайтиПоТипу(ТипДокумента);
	ВходящиеДанные = РеглУчетВыборкиСерверПовтИсп.ИспользуемыеТаблицыДляОтраженияТипа(ОбъектМетаданных.Имя);
	
	ИмяВременнойТаблицы = Неопределено;
	Если ТипЗнч(Отбор) = Тип("МенеджерВременныхТаблиц") Тогда
		ИмяВременнойТаблицы = "ДокументыКОтражению";
	КонецЕсли;
	
	ЕстьБлокировкаДанных = ЕстьБлокировкаДанных(ВходящиеДанные, Отбор, ИмяВременнойТаблицы);
	Если ЕстьБлокировкаДанных Тогда
		// Нельзя выполнять отражение документов в регл. учете - не завершено обновление всех входящих данных.
		ОписаниеОшибки = СтрШаблон(
			НСтр("ru = 'Отражение документов ""%1""
				|в регламентированном учете остановлено из-за блокировки входящих данных - не завершено обновление ИБ.'"),
			ТипДокумента);
		
		Если ТипЗнч(Отбор) <> Тип("МенеджерВременныхТаблиц") И ТипЗнч(Отбор) <> Тип("Массив") И ЗначениеЗаполнено(Отбор) Тогда
			ОписаниеОшибки = СтрШаблон(
			НСтр("ru = 'Отражение документа ""%1""
				|в регламентированном учете остановлено из-за блокировки входящих данных - не завершено обновление ИБ.'"),
			Отбор);
		КонецЕсли;
		
		ЗаписьЖурналаРегистрации(
			НСтр("ru = 'Отражение в регламентированном учете'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()),
			УровеньЖурналаРегистрации.Ошибка,
			ОбъектМетаданных,
			Отбор,
			ОписаниеОшибки);
			
		ВызватьИсключение ОписаниеОшибки;
	КонецЕсли;
		
КонецПроцедуры

// Проверяет, есть ли еще заблокированные обновлением данные.
// В случае если передан массив проверяемых объектов и среди них присутствуют независимые регистры сведений,
// то для таких регистров наличие блокировки проверяется без отбора - если есть ли хоть одна заблокированная запись, 
// то регистр сведений считается заблокированным полностью.
// Проверки независимых регистров сведений с отбором по измерениям возможна только для одного объекта метаданных.
//
// Параметры:
//  ПолныеИменаМетаданныеОбъектов - Строка, ОбъектМетаданных, Массив строк, Массив ОбъектовМетаданных - полное имя
//      обрабатываемого объекта или его метаданные или массив имен или объектов.
//									Например, "Документ.ПриходныйОрдерНаТовары"
//  Отбор - ЛюбаяСсылка, Структура, Неопределено, Массив, МенеджерВременныхТаблиц - отбор данных для проверки.
//									Если передано Неопределено - проверяется по всему типу объекта без отбора,
//									Если объект - регистр, подчиненный регистратору, то в отборе - ссылка на регистратор или массив ссылок
//									Если объект ссылочного типа, то в отборе - или ссылка, или массив ссылок
//									Если объект - независимый регистр сведений, то в отборе - структура со значениями измерений.
//										Ключ структуры - имя измерения, значение - значение отбора (можно передать массив значений)
//	ИмяВременнойТаблицыОтбора - Строка - Имя временной таблицы если отбор задан МенеджеромВременныхТаблиц, если отбор не МенеджерВременныхТаблиц, то игнорируется
//	ИзмеренияРегистраСведений - Строка, Массив - Имена измерений независимого регистра сведений через запятую или в массиве, 
//									по которым необходимо выполнить внутреннее соединение с таблицей отбора переданной в МенеджереВременныхТаблиц.
// 
// Возвращаемое значение:
//  Булево
//
Функция ЕстьБлокировкаДанных(ПолныеИменаМетаданныеОбъектов, Отбор = Неопределено, ИмяВременнойТаблицыОтбора = Неопределено, ИзмеренияРегистраСведений = Неопределено)
	
	Если ПолучитьФункциональнуюОпцию("ОтложенноеОбновлениеЗавершеноУспешно") Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Если ТипЗнч(ПолныеИменаМетаданныеОбъектов) = Тип("Массив") Тогда
		МассивПолныхИменМетаданныхОбъектов = ПолныеИменаМетаданныеОбъектов;
	Иначе
		МассивПолныхИменМетаданныхОбъектов = Новый Массив;
		МассивПолныхИменМетаданныхОбъектов.Добавить(ПолныеИменаМетаданныеОбъектов);
	КонецЕсли;
	
	Если ТипЗнч(ИзмеренияРегистраСведений) = Тип("Массив") Тогда
		МассивИзмеренийРегистраСведений = ИзмеренияРегистраСведений;
	ИначеЕсли ТипЗнч(ИзмеренияРегистраСведений) = Тип("Строка") Тогда
		МассивИзмеренийРегистраСведений = СтрРазделить(ИзмеренияРегистраСведений,",",Ложь);
	КонецЕсли;
	
	МассивТекстовЗапросов = Новый Массив;
	ОтборПоСсылкам = ТипЗнч(Отбор) <> Тип("МенеджерВременныхТаблиц") И ЗначениеЗаполнено(Отбор);
	ОтборПоВременнойТаблице = ТипЗнч(Отбор) = Тип("МенеджерВременныхТаблиц");
	Для Каждого ПолноеИмяМетаданныеОбъекта Из МассивПолныхИменМетаданныхОбъектов Цикл
	
		Если ТипЗнч(ПолноеИмяМетаданныеОбъекта) = Тип("Строка") Тогда
			МетаданныеОбъекта = Метаданные.НайтиПоПолномуИмени(ПолноеИмяМетаданныеОбъекта);
			ПолноеИмяОбъекта = ПолноеИмяМетаданныеОбъекта;
		Иначе
			МетаданныеОбъекта = ПолноеИмяМетаданныеОбъекта;
			ПолноеИмяОбъекта  = МетаданныеОбъекта.ПолноеИмя();
		КонецЕсли;
		
		УсловиеОтбораДанных = "ИСТИНА";
		ТекстВыборкиИзмерений = "ТаблицаИзменений.Ссылка КАК Ссылка";
		Если ОбщегоНазначения.ЭтоОбъектСсылочногоТипа(МетаданныеОбъекта) Тогда
			ТекстЗапроса =
			"ВЫБРАТЬ ПЕРВЫЕ 1
			|	ТаблицаИзменений.Ссылка КАК Ссылка
			|ИЗ
			|	#ТаблицаИзменения КАК ТаблицаИзменений
			|ГДЕ
			|	ТаблицаИзменений.Узел ССЫЛКА ПланОбмена.ОбновлениеИнформационнойБазы
			|	И &УсловиеОтбораДанных";
			
			Если ОтборПоСсылкам Тогда
				УсловиеОтбораДанных = "ТаблицаИзменений.Ссылка В (&МассивСсылок)";
			ИначеЕсли ОтборПоВременнойТаблице Тогда
				
				ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
								"	#ТаблицаИзменения КАК ТаблицаИзменений",
								"	#ТаблицаИзменения КАК ТаблицаИзменений
								|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ #ТаблицаОтбора КАК Отбор
								|	ПО ТаблицаИзменений.Ссылка = Отбор.Ссылка");
				ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "#ТаблицаОтбора", ИмяВременнойТаблицыОтбора);
				
			КонецЕсли;
				
		ИначеЕсли ОбщегоНазначения.ЭтоРегистрСведений(МетаданныеОбъекта)
			И МетаданныеОбъекта.РежимЗаписи = Метаданные.СвойстваОбъектов.РежимЗаписиРегистра.Независимый Тогда
			
			ТекстЗапроса =
			"ВЫБРАТЬ ПЕРВЫЕ 1
			|	&ТекстВыборкиИзмерений
			|ИЗ
			|	#ТаблицаИзменения КАК ТаблицаИзменений
			|ГДЕ
			|	ТаблицаИзменений.Узел ССЫЛКА ПланОбмена.ОбновлениеИнформационнойБазы
			|	И &УсловиеОтбораДанных";
			
			ТекстВыборкиИзмерений = "";
			НовоеУсловиеОтбораДанных = "";
			Для Каждого Измерение Из МетаданныеОбъекта.Измерения Цикл
				
				Если МассивПолныхИменМетаданныхОбъектов.Количество() > 1 Тогда
					ТекстВыборкиИзмерений = "ТаблицаИзменений." + Измерение.Имя + " КАК Ссылка";
					Прервать;
					
				Иначе
					ТекстВыборкиИзмерений = ТекстВыборкиИзмерений + "
						|	ТаблицаИзменений." + Измерение.Имя + " КАК " + Измерение.Имя + ",";
					Если ТипЗнч(Отбор) = Тип("Структура") И Отбор.Свойство(Измерение.Имя) Тогда
						НовоеУсловиеОтбораДанных = НовоеУсловиеОтбораДанных + "
							|	(ТаблицаИзменений." + Измерение.Имя + " В (&" + Измерение.Имя + ")
							|		ИЛИ &" + Измерение.Имя + " = НЕОПРЕДЕЛЕНО)
							|	И ";
					КонецЕсли;
				КонецЕсли;
					
			КонецЦикла;// по измерениям регистра
			
			Если МассивПолныхИменМетаданныхОбъектов.Количество() = 1 Тогда
				ТекстВыборкиИзмерений = Лев(ТекстВыборкиИзмерений, СтрДлина(ТекстВыборкиИзмерений) - 1);
				Если НЕ ПустаяСтрока(НовоеУсловиеОтбораДанных) Тогда
					УсловиеОтбораДанных = Лев(НовоеУсловиеОтбораДанных, СтрДлина(НовоеУсловиеОтбораДанных) - 3);
				КонецЕсли;
			КонецЕсли;
			
			Если ОтборПоВременнойТаблице И ИзмеренияРегистраСведений <> Неопределено Тогда
				
				ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
						"	#ТаблицаИзменения КАК ТаблицаИзменений",
						"	#ТаблицаИзменения КАК ТаблицаИзменений
						|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ #ТаблицаОтбора КАК Отбор
						|	ПО ТаблицаИзменений.Ссылка = Отбор.Ссылка");
				ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "#ТаблицаОтбора", ИмяВременнойТаблицыОтбора);
				
				ТекстСоединения = "";
				Для Каждого Измерение Из МассивИзмеренийРегистраСведений Цикл
					ТекстСоединения = ТекстСоединения +
						СтрШаблон("ТаблицаИзменений.%1 = Отбор.Ссылка
								|	И ", Измерение);
				КонецЦикла;
				ТекстСоединения = Лев(ТекстСоединения, СтрДлина(ТекстСоединения) - 3);
				ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "ТаблицаИзменений.Ссылка = Отбор.Ссылка", ТекстСоединения);
				
			КонецЕсли;
			
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ТекстВыборкиИзмерений", ТекстВыборкиИзмерений);
			
		ИначеЕсли ОбщегоНазначения.ЭтоРегистр(МетаданныеОбъекта) Тогда
			
			ТекстЗапроса =
			"ВЫБРАТЬ ПЕРВЫЕ 1
			|	ТаблицаИзменений.Регистратор КАК Ссылка
			|ИЗ
			|	#ТаблицаИзменения КАК ТаблицаИзменений
			|ГДЕ
			|	ТаблицаИзменений.Узел ССЫЛКА ПланОбмена.ОбновлениеИнформационнойБазы
			|	И &УсловиеОтбораДанных";
			
			Если ОтборПоСсылкам Тогда
				УсловиеОтбораДанных = "ТаблицаИзменений.Регистратор В (&МассивСсылок)";
			ИначеЕсли ОтборПоВременнойТаблице Тогда
				
				ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
								"	#ТаблицаИзменения КАК ТаблицаИзменений",
								"	#ТаблицаИзменения КАК ТаблицаИзменений
								|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ #ТаблицаОтбора КАК Отбор
								|	ПО ТаблицаИзменений.Регистратор = Отбор.Ссылка");
				ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "#ТаблицаОтбора", ИмяВременнойТаблицыОтбора);
				
			КонецЕсли;
			
		Иначе
			ТекстИсключения = НСтр("ru = 'Для этого типа метаданных не поддерживается проверка в функции ОбновлениеИнформационнойБазы.ЕстьДанныеДляОбработки'");
			ВызватьИсключение ТекстИсключения;
		КонецЕсли;
		
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "#ТаблицаИзменения", ПолноеИмяОбъекта + ".Изменения");
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&УсловиеОтбораДанных", УсловиеОтбораДанных);
		МассивТекстовЗапросов.Добавить(ТекстЗапроса);
		
	КонецЦикла;
	
	Соединитель = "
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|";
	
	ТекстЗапроса = СтрСоединить(МассивТекстовЗапросов, Соединитель);
	Запрос = Новый Запрос;
	Если ОтборПоСсылкам Тогда
		Запрос.УстановитьПараметр("МассивСсылок", Отбор);
	ИначеЕсли ТипЗнч(Отбор) = Тип("Структура") Тогда
		Для Каждого Измерение Из Отбор Цикл
			Запрос.УстановитьПараметр(Измерение.Ключ, ?(ЗначениеЗаполнено(Измерение.Значение), Измерение.Значение, Неопределено));
		КонецЦикла;
	ИначеЕсли ОтборПоВременнойТаблице Тогда
		Запрос.МенеджерВременныхТаблиц = Отбор;
	КонецЕсли;
	Запрос.Текст = ТекстЗапроса;
	
	Возврат НЕ Запрос.Выполнить().Пустой(); 
	
КонецФункции

#КонецОбласти

Функция ИменаДокументовОтражаемыеВРеглУчетеВнеЗависимостиОтДаты()
	
	МассивВозврата = Новый Массив;
	
	МассивВозврата.Добавить("ВводОстатков");
	МассивВозврата.Добавить("ВводОстатковВнеоборотныхАктивов");
	МассивВозврата.Добавить("ВводОстатковВнеоборотныхАктивов2_4");
	МассивВозврата.Добавить("ОперацияБух");
	МассивВозврата.Добавить("ПервичныйДокумент");
	
	Возврат МассивВозврата;
	
КонецФункции

Функция ИменаДокументовОтражаемыеВРеглУчетеВнеЗависимостиОтДатыЗависящиеОтОснования()
	
	МассивВозврата = Новый Массив;
	
	МассивВозврата.Добавить("СчетФактураВыданныйАванс");
	МассивВозврата.Добавить("СчетФактураПолученныйАванс");
	МассивВозврата.Добавить("СчетФактураНалоговыйАгент");
	
	Возврат МассивВозврата;
	
КонецФункции

Процедура ПроверитьДатуЗапретаДляОтраженияДокументовВРеглУчете(ШаблонЗапретаДанных, НаборЗаписей = Неопределено, ОтражаемыйДокумент = Неопределено)
	
	Если НаборЗаписей = Неопределено Тогда
		Отбор = Новый Структура;
		НаборЗаписей = Новый Структура("Регистр, Отбор", "РегистрСведений.ОтражениеДокументовВРеглУчете", Отбор);
	Иначе
		НаборЗаписей.ДополнительныеСвойства.Вставить("ПроверкаДатыЗапретаИзменения", Ложь);
	КонецЕсли;
	
	ОписаниеДанных = Новый Структура("НоваяВерсия, Данные", Истина, НаборЗаписей);
	ОписаниеОшибки = "";
	Если ДатыЗапретаИзменения.НайденЗапретИзмененияДанных(ШаблонЗапретаДанных, ОписаниеДанных, ОписаниеОшибки) Тогда
	
		ЗаписьЖурналаРегистрации(
			НСтр("ru = 'Установка нового статуса отражения в учете'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()),
			УровеньЖурналаРегистрации.Ошибка,
			?(ОтражаемыйДокумент = Неопределено, ОтражаемыйДокумент, ОтражаемыйДокумент.Метаданные()),
			?(ОтражаемыйДокумент = Неопределено, ОтражаемыйДокумент, ОтражаемыйДокумент),
			ОписаниеОшибки);
		
		ВызватьИсключение ОписаниеОшибки;
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти
